<!doctype html>
<meta charset="utf-8">
<title>What Is My Delta ‚Äî Clean Interface</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="stylesheet" href="css/tokens.css"/>
<link rel="stylesheet" href="css/styles.css"/>
<style>
  :root{--fg:#000;--muted:#666;--line:#e8e8e8;--hair:#111;--max:980px}
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);color:var(--fg)}
  body{font:12px/1.75 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  a:hover,a:focus{text-decoration:underline}
  .wrap{max-width:var(--max);margin:0 auto;padding:28px 20px;box-shadow:0 2px 8px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);background:linear-gradient(145deg, #ffffff 0%, #fafafa 100%);border-radius:4px}

  .nav{display:flex;gap:24px;margin-bottom:60px}
  .hero{margin:120px 0 40px}
  .title{font:500 15px/1.4 Helvetica,Arial;letter-spacing:.02em}
  .sub{color:var(--muted);max-width:64ch}
  .actions{margin:24px 0 0;display:flex;gap:16px;align-items:center}
  .quiet{border:1px solid var(--line);padding:6px 10px;background:#fff}

  .chat{position:fixed;right:20px;bottom:20px;width:320px;max-width:90vw;background:#fff;border:1px solid var(--line);box-shadow:0 8px 30px rgba(0,0,0,.06);display:none}
  .chat header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line)}
  .chat header .x{border:1px solid var(--line);padding:2px 6px;background:#fff}
  .chat main{padding:10px 12px;height:220px;overflow:auto}
  .msg{margin:6px 0}
  .chat footer{padding:8px 10px;border-top:1px solid var(--line);display:flex;gap:6px}
  .chat input{flex:1;border:1px solid var(--line);padding:6px 8px}

  .modal{position:fixed;inset:0;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
  .modal .panel{background:#fff;border:1px solid var(--line);padding:20px;min-width:280px;max-width:92vw}
  .modal .close{margin-top:16px;border:1px solid var(--line);background:#fff;padding:6px 10px}
  .drop{border:1px dashed #ccc;padding:24px;text-align:center}

  .status{font-size:11px;color:var(--muted);margin-top:8px}
  .status.error{color:#b00020}
  .status.ok{color:#2d7a2d}
  
  /* Enhanced depth and detail */
  .flow-circle {
    background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%);
    box-shadow: 
      0 3px 6px rgba(0,0,0,0.08),
      0 1px 3px rgba(0,0,0,0.04),
      inset 0 1px 0 rgba(255,255,255,0.9);
    transition: all 0.2s ease;
  }
  
  .flow-circle:hover {
    background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
    box-shadow: 
      0 4px 12px rgba(0,0,0,0.12),
      0 2px 6px rgba(0,0,0,0.06),
      inset 0 1px 0 rgba(255,255,255,0.95);
    transform: translateY(-2px);
  }
  
  .flow-circle.active {
    background: linear-gradient(145deg, #ffffff 0%, #f5f5f5 100%);
    box-shadow: 
      0 5px 15px rgba(0,0,0,0.15),
      0 3px 8px rgba(0,0,0,0.08),
      inset 0 1px 0 rgba(255,255,255,0.98);
  }
  
  .quiet {
    background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%);
    box-shadow: 
      0 2px 4px rgba(0,0,0,0.06),
      inset 0 1px 0 rgba(255,255,255,0.8);
    transition: all 0.15s ease;
  }
  
  .quiet:hover {
    background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
    box-shadow: 
      0 3px 8px rgba(0,0,0,0.10),
      inset 0 1px 0 rgba(255,255,255,0.9);
    transform: translateY(-1px);
  }
  
  .quiet:active {
    transform: translateY(0);
    background: linear-gradient(145deg, #f8f8f8 0%, #eeeeee 100%);
    box-shadow: 
      0 1px 3px rgba(0,0,0,0.04),
      inset 0 1px 0 rgba(255,255,255,0.6);
  }
  
  .section-card {
    background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
    box-shadow: 
      0 2px 6px rgba(0,0,0,0.06),
      0 1px 3px rgba(0,0,0,0.03);
    transition: all 0.2s ease;
  }
  
  .section-card:hover {
    background: linear-gradient(145deg, #ffffff 0%, #f5f5f5 100%);
    box-shadow: 
      0 4px 12px rgba(0,0,0,0.10),
      0 2px 6px rgba(0,0,0,0.06);
  }
  .job-card{border:1px solid var(--line);padding:12px;margin:12px 0;cursor:pointer;transition:border-color .2s ease}
  .job-card.selected{border-color:var(--hair)}
  .job-card.applied{border-style:dashed}
  .job-actions{display:flex;gap:8px;margin-top:10px}
  .pill{display:inline-block;border:1px solid var(--line);padding:2px 6px;margin:2px 4px 0 0;font-size:10px;color:var(--muted)}
  .muted{color:var(--muted);font-size:11px}
  .resume-output{border:1px solid var(--line);padding:12px;background:#fafafa;margin-top:12px;white-space:pre-wrap}
  .loading{opacity:.6;pointer-events:none}
  @media (max-width:860px){.nav{flex-direction:column;gap:12px}}

  /* PS101 Styles */
  .ps101-welcome{max-width:640px;margin:80px auto;padding:40px 20px;text-align:center}
  .ps101-welcome.hidden{display:none}
  .ps101-container.hidden{display:none}
  .ps101-completion.hidden{display:none}
  .previous-answers.hidden{display:none}
  .welcome-resume.hidden{display:none}
  .welcome-title{font-size:28px;font-weight:600;margin:0 0 8px;color:var(--fg)}
  .welcome-subtitle{font-size:14px;font-weight:400;color:var(--muted);margin:0 0 32px;letter-spacing:.05em;text-transform:uppercase}
  .welcome-description{margin-bottom:32px;text-align:left}
  .welcome-description p{font-size:14px;line-height:1.6;color:var(--fg);margin-bottom:16px}
  .welcome-features{list-style:none;padding:0;margin:0}
  .welcome-features li{font-size:13px;line-height:2;color:var(--muted)}
  .welcome-actions{display:flex;flex-direction:column;gap:12px;margin-bottom:24px}
  .welcome-btn-primary{font-weight:500;background:linear-gradient(145deg,#fff 0%,#f8f8f8 100%);border-color:var(--hair)}
  .welcome-btn-secondary{background:transparent;border-color:var(--line)}
  .welcome-resume{margin-top:32px;padding-top:24px;border-top:1px solid var(--line)}
  .resume-text{font-size:12px;color:var(--muted);margin-bottom:12px}

  .ps101-container{max-width:var(--max);margin:0 auto;padding:40px 20px}
  .ps101-progress{max-width:var(--max);margin:0 auto 40px;padding:20px}
  .progress-header{text-align:center;margin-bottom:16px}
  .step-label{font-size:14px;font-weight:500;color:var(--fg);letter-spacing:.02em}
  .progress-dots{display:flex;justify-content:center;gap:12px;align-items:center;flex-wrap:wrap}
  .progress-dots .dot{width:32px;height:32px;border-radius:50%;border:1px solid var(--line);background:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);cursor:pointer;transition:all 0.2s ease}
  .progress-dots .dot:hover{border-color:var(--hair);transform:translateY(-1px)}
  .progress-dots .dot.completed{background:linear-gradient(145deg,#f5f5f5 0%,#eee 100%);color:var(--fg);border-color:var(--hair)}
  .progress-dots .dot.active{background:linear-gradient(145deg,#fff 0%,#f8f8f8 100%);box-shadow:0 3px 8px rgba(0,0,0,0.12);color:var(--fg);font-weight:600;border-color:var(--hair)}
  .progress-dots .dot:disabled{cursor:not-allowed;opacity:0.5}

  /* Experiment Components Styles */
  .experiment-components{margin:32px 0;padding:24px;border:1px solid var(--line);border-radius:6px;background:linear-gradient(145deg,#fff 0%,#fafafa 100%)}
  .experiment-components.hidden{display:none}
  .component-title{font-size:16px;font-weight:600;margin-bottom:20px;color:var(--fg)}
  .experiment-form{display:flex;flex-direction:column;gap:16px}
  .form-group{display:flex;flex-direction:column;gap:6px}
  .form-group label{font-size:12px;font-weight:500;text-transform:uppercase;letter-spacing:.05em;color:var(--muted)}
  .form-group textarea,.form-group input[type="text"],.form-group input[type="date"],.form-group select{width:100%;padding:8px 12px;border:1px solid var(--line);border-radius:3px;font-size:13px;font-family:inherit;background:#fff;transition:border-color 0.2s ease}
  .form-group textarea:focus,.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--hair);box-shadow:0 0 0 2px rgba(0,0,0,0.04)}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .btn-add{padding:8px 16px;border:1px solid var(--line);background:transparent;color:var(--fg);cursor:pointer;border-radius:3px;font-size:12px;transition:all 0.2s ease;margin-top:8px}
  .btn-add:hover{background:var(--line);border-color:var(--hair)}

  /* Obstacle Mapping */
  .obstacle-item,.action-item{margin-bottom:16px;padding:12px;border:1px solid var(--line);border-radius:4px;background:#fff}
  .obstacle-header,.action-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .obstacle-type{display:inline-block;padding:2px 8px;border-radius:12px;font-size:10px;text-transform:uppercase;font-weight:600;background:var(--line);color:var(--muted)}
  .obstacle-type.external{background:#e3f2fd;color:#1976d2}
  .obstacle-type.internal{background:#fff3e0;color:#f57c00}
  .obstacle-strategy{margin-top:8px;padding-top:8px;border-top:1px solid var(--line)}
  .action-checkbox{display:flex;align-items:center;gap:8px}
  .action-checkbox input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
  .action-due{font-size:11px;color:var(--muted);margin-top:4px}
  .btn-remove{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:0;line-height:1;opacity:0.6;transition:opacity 0.2s ease}
  .btn-remove:hover{opacity:1}

  /* Reflection */
  .confidence-slider-container{display:flex;align-items:center;gap:12px}
  .confidence-slider-container input[type="range"]{flex:1}
  #confidence-value{font-weight:600;min-width:30px;text-align:center}

  /* Add Form Containers */
  .add-form-container{margin-top:16px;padding:16px;background:var(--bg-secondary);border:1px solid var(--line);border-radius:4px}
  .add-form-container.hidden{display:none}
  .form-error{font-size:12px;color:#d63638;margin-top:4px;display:block}
  .form-error.hidden{display:none}

  .previous-answers{margin-bottom:32px;border:1px solid var(--line);border-radius:4px;background:linear-gradient(145deg,#fafafa 0%,#f5f5f5 100%);padding:16px}
  .previous-answers summary{cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;padding:8px 0}
  .previous-answers summary:hover .summary-text{color:var(--fg)}
  .summary-text{font-size:13px;font-weight:500;color:var(--muted);transition:color 0.2s ease}
  .summary-hint{font-size:11px;color:var(--muted)}
  .answer-list{margin-top:16px;display:flex;flex-direction:column;gap:12px}
  .answer-card{background:#fff;border:1px solid var(--line);border-radius:4px;padding:12px;transition:box-shadow 0.2s ease}
  .answer-card:hover{box-shadow:0 2px 6px rgba(0,0,0,0.06)}
  .answer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .answer-step{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--fg)}
  .answer-edit{font-size:11px;padding:4px 8px;border:1px solid var(--line);background:transparent;cursor:pointer;border-radius:2px;transition:all 0.2s ease}
  .answer-edit:hover{background:var(--line)}
  .answer-content{font-size:12px;line-height:1.5;color:var(--muted);white-space:pre-wrap}

  .ps101-question{margin-bottom:32px}
  .question-text{font-size:18px;font-weight:400;line-height:1.5;color:var(--fg);margin:0 0 16px}
  .coaching-hint{margin-top:12px;padding:12px;background:linear-gradient(145deg,#fafafa 0%,#f5f5f5 100%);border:1px solid var(--line);border-radius:4px}
  .coaching-hint summary{font-size:12px;cursor:pointer;user-select:none;color:var(--muted)}
  .coaching-hint summary:hover{color:var(--fg)}
  .coaching-hint p{margin:8px 0 0;font-size:12px;line-height:1.5;color:var(--muted)}

  .ps101-input{margin-bottom:24px}
  .step-textarea{width:100%;min-height:120px;padding:12px;border:1px solid var(--line);border-radius:4px;font:inherit;font-size:13px;line-height:1.6;resize:vertical;transition:all 0.2s ease}
  .step-textarea:focus{outline:none;border-color:var(--hair);box-shadow:0 2px 8px rgba(0,0,0,0.08)}
  .char-count{margin-top:8px;font-size:11px;color:var(--muted);text-align:right}

  .ps101-nav{display:flex;justify-content:space-between;margin-top:32px;gap:16px}
  .nav-btn{min-width:120px;padding:10px 20px;font-size:13px}
  .nav-back{background:transparent;border-color:var(--line)}
  .nav-next{background:linear-gradient(145deg,#fff 0%,#f8f8f8 100%);border-color:var(--hair);font-weight:500}
  .nav-btn:disabled{opacity:0.5;cursor:not-allowed}

  .autosave-indicator{margin-top:16px;text-align:center;font-size:11px;color:var(--muted);opacity:0;transition:opacity 0.3s ease}
  .autosave-indicator.visible{opacity:1}

  .ps101-completion{max-width:var(--max);margin:40px auto;padding:40px 20px}
  .ps101-completion.hidden{display:none}
  .completion-header{text-align:center;margin-bottom:32px}
  .completion-title{font-size:22px;font-weight:600;color:var(--fg);margin:0 0 16px}
  .completion-progress{font-size:16px;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px}
  .completion-label{font-size:12px;color:var(--muted)}
  .completion-message{text-align:center;margin-bottom:32px}
  .completion-message p{font-size:14px;color:var(--muted)}
  .commitment-highlight{background:linear-gradient(145deg,#fafafa 0%,#f5f5f5 100%);border:1px solid var(--line);border-radius:4px;padding:20px;margin-bottom:32px}
  .commitment-label{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--fg);margin:0 0 12px}
  .commitment-text{font-size:14px;line-height:1.6;color:var(--fg);margin-bottom:8px;white-space:pre-wrap}
  .commitment-deadline{font-size:12px;color:var(--muted);font-weight:500}
  .completion-summary{margin-bottom:32px;border:1px solid var(--line);border-radius:4px;padding:16px}
  .completion-summary summary{cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);user-select:none}

  @media (max-width:768px){
    .ps101-welcome{margin:40px auto;padding:24px 16px}
    .welcome-title{font-size:24px}
    .ps101-container{padding:24px 16px}
    .question-text{font-size:16px}
  }
</style>

<div class="wrap">
  <nav class="nav">
    <a id="openUpload" href="#" title="Upload a resume, image, or audio">upload</a>
    <a id="openChat" href="#" title="Open coaching chat">chat</a>
    <a id="showGuide" href="#" title="Show user guide">guide</a>
    <button id="logoutBtn" class="quiet" style="padding:4px 8px;font-size:9px;text-transform:uppercase;letter-spacing:.08em" hidden>logout</button>
  </nav>


  <header class="hero" id="top">
    <div class="title">WHAT IS MY DELTA</div>
    <p class="sub">career transition platform. discover your path. find your fit. take action.</p>
  </header>

  <!-- LOGIN/REGISTER MODAL -->
  <div id="authModal" class="modal" style="display:block">
    <div class="panel" style="max-width:400px">
      <h2 style="font:600 14px/1.2 Helvetica,Arial;margin:0 0 20px;text-transform:uppercase;letter-spacing:.08em;text-align:center">welcome to your career transition</h2>
      
      <!-- LOGIN FORM -->
      <form id="loginForm" style="margin-bottom:20px">
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">email</label>
          <input type="email" id="loginEmail" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">password</label>
          <input type="password" id="loginPassword" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px;text-align:right">
          <a href="#" id="forgotPassword" style="font-size:9px;color:var(--muted);text-decoration:underline">forgot password?</a>
        </div>
        <button type="submit" class="quiet" style="width:100%;padding:10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;background:var(--hair);color:#fff;border:1px solid var(--hair)">sign in</button>
      </form>
      
      <!-- REGISTER FORM -->
      <form id="registerForm" style="margin-bottom:20px" hidden>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">email</label>
          <input type="email" id="registerEmail" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">password</label>
          <input type="password" id="registerPassword" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">confirm password</label>
          <input type="password" id="registerConfirm" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">discount code <span style="color:var(--muted);font-weight:400">(optional)</span></label>
          <input type="text" id="registerDiscountCode" style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px;text-transform:uppercase" placeholder="BETA2025">
        </div>
        <button type="submit" class="quiet" style="width:100%;padding:10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;background:var(--hair);color:#fff;border:1px solid var(--hair)">create account</button>
      </form>
      
      <div style="text-align:center;margin-top:16px">
        <button id="toggleAuth" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">need an account?</button>
      </div>
      
      <div id="authStatus" class="status" style="margin-top:12px;text-align:center"></div>
    </div>
  </div>

  <!-- PASSWORD RESET MODAL -->
  <div id="resetModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1001">
    <div style="background:#fff;padding:32px;border-radius:4px;max-width:400px;width:90%;box-shadow:0 8px 30px rgba(0,0,0,.12)">
      <h2 style="font:600 14px/1.2 Helvetica,Arial;margin:0 0 20px;text-transform:uppercase;letter-spacing:.08em;text-align:center">reset password</h2>

      <form id="resetForm" style="margin-bottom:20px">
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">email</label>
          <input type="email" id="resetEmail" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <button type="submit" class="quiet" style="width:100%;padding:10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;background:var(--hair);color:#fff;border:1px solid var(--hair)">send reset link</button>
      </form>

      <div style="text-align:center;margin-top:16px">
        <button id="closeReset" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">cancel</button>
      </div>

      <div id="resetStatus" class="status" style="margin-top:12px;text-align:center"></div>
    </div>
  </div>

  <!-- WELCOME & ONBOARDING -->
  <section id="welcome" style="margin:60px 0;padding:40px 0;border:1px solid var(--line);border-radius:4px;background:linear-gradient(145deg, #ffffff 0%, #fafafa 100%)" hidden>
    <div style="max-width:var(--max);margin:0 auto;text-align:center">
      <h1 style="font:600 18px/1.2 Helvetica,Arial;margin:0 0 16px;text-transform:uppercase;letter-spacing:.08em">welcome</h1>
      <p style="margin:0 0 24px;color:var(--muted);font-size:12px;line-height:1.5;max-width:56ch;margin:0 auto 24px">career transition platform for evidence-based problem-solving</p>

      <div style="display:flex;flex-direction:column;gap:12px;align-items:center;margin:32px 0">
        <button id="startPS101" class="quiet" style="padding:12px 24px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;background:var(--hair);color:#fff;border:1px solid var(--hair);min-width:280px">start problem-solving flow</button>
        <button id="startChat" class="quiet" style="padding:10px 20px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;min-width:280px">open chat coach</button>
      </div>

      <details style="margin-top:32px;text-align:left;max-width:500px;margin:32px auto 0">
        <summary style="font-size:10px;color:var(--muted);cursor:pointer;text-transform:uppercase;letter-spacing:.08em">what is this?</summary>
        <div style="margin-top:12px;font-size:10px;color:var(--muted);line-height:1.6">
          <p style="margin-bottom:8px"><strong>Problem-Solving Flow (PS101):</strong> 10-step guided process to analyze your career challenge, discover opportunities, and create an action plan</p>
          <p style="margin-bottom:8px"><strong>Chat Coach:</strong> Open-ended conversation to explore your situation, upload files, search jobs, or optimize your resume</p>
          <p style="margin-bottom:8px"><strong>Auto-save:</strong> Everything is saved as you go</p>
        </div>
      </details>
    </div>
  </section>

  <!-- JOURNEY FLOW -->
  <section style="margin:80px 0;padding:40px 0">
    <div style="max-width:var(--max);margin:0 auto">
      <h2 style="font:600 12px/1 Helvetica,Arial;margin:0 0 40px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)">your career transition</h2>
      
      <!-- ORGANIC FLOW -->
      <div style="display:flex;justify-content:center;align-items:center;margin:60px 0;position:relative">
            <!-- EXPLORE -->
            <div style="position:absolute;left:0;top:0;text-align:center">
              <button id="exploreCircle" class="flow-circle" style="width:50px;height:50px;border:1px solid var(--line);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font:600 14px/1 Helvetica,Arial;background:#fff;cursor:pointer;padding:0" title="Start career exploration">E</button>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 6px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">explore</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.3;max-width:100px">skills, passions, and career goals</p>
        </div>

            <!-- FIND -->
            <div style="position:absolute;right:0;top:0;text-align:center">
              <button id="findCircle" class="flow-circle" style="width:50px;height:50px;border:1px solid var(--line);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font:600 14px/1 Helvetica,Arial;background:#fff;cursor:pointer;padding:0" title="Find job opportunities">F</button>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 6px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">find</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.3;max-width:100px">opportunities that align with you</p>
        </div>

            <!-- APPLY -->
            <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center">
              <button id="applyCircle" class="flow-circle active" style="width:60px;height:60px;border:2px solid var(--hair);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font:600 16px/1 Helvetica,Arial;background:#fff;cursor:pointer;padding:0" title="Optimize resume for roles">A</button>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 6px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">apply</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.3;max-width:100px">optimize for specific roles</p>
        </div>
        
            <!-- CONNECTING LINES -->
            <svg style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none" viewBox="0 0 300 200">
              <defs>
                <linearGradient id="lineGrad1" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:var(--line);stop-opacity:0.2" />
                  <stop offset="50%" style="stop-color:var(--line);stop-opacity:0.4" />
                  <stop offset="100%" style="stop-color:var(--line);stop-opacity:0.2" />
                </linearGradient>
              </defs>
              <path d="M50,25 Q150,100 250,25" stroke="url(#lineGrad1)" stroke-width="1.5" fill="none"/>
              <path d="M50,25 Q150,150 150,100" stroke="url(#lineGrad1)" stroke-width="1.5" fill="none"/>
              <path d="M250,25 Q150,150 150,100" stroke="url(#lineGrad1)" stroke-width="1.5" fill="none"/>
            </svg>
      </div>
      
      <!-- START ACTIONS -->
      <div style="text-align:center;margin-top:80px">
        <p style="margin:0 0 20px;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em">begin anywhere</p>
        <div style="display:flex;gap:8px;justify-content:center;align-items:center">
          <button id="startDiscoveryFlow" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em;background:var(--hair);color:#fff;border:1px solid var(--hair)">explore</button>
          <button id="openUploadFlow" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">upload</button>
          <button id="findOpportunities" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">find jobs</button>
          <a href="https://calendar.app.google/EAnDSz2CcTtH849x6" target="_blank" rel="noopener noreferrer" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em;display:inline-block" title="Book a 1-on-1 coaching session">book session</a>
        </div>
      </div>
    </div>
  </section>

  <!-- USER PROGRESS & SESSION INFO -->
  <section id="userProgress" style="margin:40px 0;padding:20px;border:1px solid var(--line);border-radius:4px;background:linear-gradient(145deg, #fafafa 0%, #f5f5f5 100%)" hidden>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="font:600 11px/1 Helvetica,Arial;margin:0;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">your progress</h3>
      <button id="clearSession" class="quiet" style="padding:4px 8px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">clear session</button>
    </div>
    <div id="progressInfo" style="font-size:10px;color:var(--muted);line-height:1.4">
      <div>Session: <span id="sessionDisplay">not started</span></div>
      <div>Path: <span id="pathDisplay">-</span></div>
      <div>Last activity: <span id="lastActivityDisplay">-</span></div>
    </div>
    
    <!-- Self-Efficacy Metrics Toggle -->
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--line)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h4 style="font:600 10px/1 Helvetica,Arial;margin:0;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">self-efficacy metrics</h4>
        <button id="toggleMetrics" class="quiet" style="padding:4px 8px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">show new metrics</button>
      </div>
      
      <!-- Legacy Metrics (Default Visible) -->
      <div id="legacyMetrics" style="font-size:10px;color:var(--muted);line-height:1.4">
        <div>Legacy metrics display (existing functionality)</div>
      </div>
      
      <!-- New Self-Efficacy Metrics (Hidden by Default) -->
      <div id="newMetrics" style="display:none;font-size:10px;color:var(--muted);line-height:1.4">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:8px">
          <!-- Experiment Completion -->
          <div class="metric-card" style="padding:12px;border:1px solid var(--line);border-radius:4px;background:#fff">
            <div style="font-weight:600;margin-bottom:4px">Experiment Completion</div>
            <div id="completionRate" style="font-size:14px;font-weight:600;color:var(--hair)">-</div>
            <div style="font-size:9px;color:var(--muted)">completed/total experiments</div>
          </div>
          
          <!-- Learning Velocity -->
          <div class="metric-card" style="padding:12px;border:1px solid var(--line);border-radius:4px;background:#fff">
            <div style="font-weight:600;margin-bottom:4px">Learning Velocity</div>
            <div id="learningVelocity" style="font-size:14px;font-weight:600;color:var(--hair)">-</div>
            <div style="font-size:9px;color:var(--muted)">events per day</div>
          </div>
          
          <!-- Confidence Score -->
          <div class="metric-card" style="padding:12px;border:1px solid var(--line);border-radius:4px;background:#fff">
            <div style="font-weight:600;margin-bottom:4px">Confidence Score</div>
            <div id="confidenceScore" style="font-size:14px;font-weight:600;color:var(--hair)">-</div>
            <div style="font-size:9px;color:var(--muted)">average confidence level</div>
          </div>
          
          <!-- Escalation Risk -->
          <div class="metric-card" style="padding:12px;border:1px solid var(--line);border-radius:4px;background:#fff">
            <div style="font-weight:600;margin-bottom:4px">Escalation Risk</div>
            <div id="escalationRisk" style="font-size:14px;font-weight:600;color:var(--hair)">-</div>
            <div style="font-size:9px;color:var(--muted)">risk level indicator</div>
          </div>
        </div>
        
        <!-- Escalation Alert -->
        <div id="escalationAlert" style="display:none;margin-top:12px;padding:12px;border:1px solid #b00020;border-radius:4px;background:#ffeaea">
          <div style="font-weight:600;color:#b00020;margin-bottom:4px">üö® Coach Escalation Needed</div>
          <div id="escalationMessage" style="font-size:10px;color:#b00020;line-height:1.4"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- USER GUIDE & HELP -->
  <section id="userGuide" style="margin:60px 0;padding:40px 0;border:1px solid var(--line);border-radius:4px;background:linear-gradient(145deg, #ffffff 0%, #fafafa 100%)" hidden>
    <div style="max-width:var(--max);margin:0 auto">
      <h2 style="font:600 12px/1 Helvetica,Arial;margin:0 0 20px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">user guide</h2>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:24px;margin:20px 0">
        <div>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 8px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">getting started</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.4">Start by chatting with the coach or uploading your resume. The system will guide you through career discovery.</p>
        </div>
        
        <div>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 8px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">chat with coach</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.4">Ask questions about your career, skills, or goals. The AI coach provides personalized guidance.</p>
        </div>
        
        <div>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 8px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">upload files</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.4">Upload your resume, documents, or audio files for deeper analysis and personalized insights.</p>
        </div>
        
        <div>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 8px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">find opportunities</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.4">Discover job opportunities that match your skills, values, and career goals.</p>
        </div>
        
        <div>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 8px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">optimize resume</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.4">Get personalized resume recommendations and optimize your materials for specific roles.</p>
        </div>
        
        <div>
          <h3 style="font:600 10px/1 Helvetica,Arial;margin:0 0 8px;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">your data</h3>
          <p style="margin:0;font-size:9px;color:var(--muted);line-height:1.4">All your conversations, uploads, and progress are saved securely and can be exported anytime.</p>
        </div>
      </div>
      
      <div style="text-align:center;margin-top:24px">
        <button id="hideGuide" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">hide guide</button>
      </div>
    </div>
  </section>

  <!-- STATUS AND OUTPUTS -->
  <div id="status" class="status" aria-live="polite"></div>
  <div id="jobsStatus" class="status" aria-live="polite"></div>
  <div id="jobsList" aria-live="polite"></div>
  
  <!-- RESUME CONTROLS -->
  <section id="resumeControls" style="margin:40px 0;padding:20px;border:1px solid var(--line);border-radius:4px;background:linear-gradient(145deg, #fafafa 0%, #f5f5f5 100%)" hidden>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="font:600 11px/1 Helvetica,Arial;margin:0;text-transform:uppercase;letter-spacing:.08em;color:var(--hair)">resume tools</h3>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <button id="resumeRewrite" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">rewrite</button>
      <button id="resumeCustomize" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">customize</button>
      <button id="resumeFeedback" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">feedback</button>
    </div>
  </section>
  
  <div id="resumeStatus" class="status" aria-live="polite"></div>
  <pre id="resumeOutput" class="resume-output" hidden></pre>

  <!-- FOOTER -->
  <footer style="border-top:1px solid var(--line);margin-top:140px;padding:14px 0;color:#777;font-size:12px;display:flex;justify-content:space-between">
    <div>¬© <span id="y"></span> Delta</div>
    <div>privacy ¬∑ terms ¬∑ support</div>
  </footer>
</div>

<!-- CHAT -->
<aside class="chat" id="chat">
  <header>
    <div>coaching</div>
    <button class="x" id="closeChat" title="Close">√ó</button>
  </header>
  <main id="chatLog" aria-live="polite"></main>
  <footer>
    <input id="chatInput" placeholder="type and enter‚Ä¶" aria-label="message">
    <button class="btn" id="sendMsg">send</button>
  </footer>
</aside>

<!-- UPLOAD MODAL -->
<div class="modal" id="uploadModal">
  <div class="panel">
    <div class="drop">
      <div style="margin-bottom:10px">upload a resume, image, or audio</div>
      <input type="file" id="filePick" multiple>
    </div>
    <div id="uploadStatus" class="status" aria-live="polite"></div>
    <button class="close" id="closeUpload">close</button>
  </div>
</div>

<!-- PS101 Welcome Screen -->
<div class="ps101-welcome hidden" id="ps101-welcome">
  <div class="welcome-content">
    <h1 class="welcome-title">Welcome to PS101</h1>
    <p class="welcome-subtitle">Problem Solving 101</p>

    <div class="welcome-description">
      <p>A 7-step framework to get clarity on your career challenge and create an action plan.</p>
      <ul class="welcome-features">
        <li>‚è± Takes 15-30 minutes</li>
        <li>üíæ Progress auto-saves</li>
        <li>‚úèÔ∏è Edit previous answers anytime</li>
      </ul>
    </div>

    <div class="welcome-actions">
      <button class="quiet welcome-btn-primary" id="start-ps101">
        Start PS101 Flow
      </button>

      <button class="quiet welcome-btn-secondary" id="learn-more-ps101">
        Learn More
      </button>
    </div>

    <div class="welcome-resume hidden" id="welcome-resume">
      <p class="resume-text">Already started? Your progress is saved.</p>
      <button class="quiet" id="continue-ps101">
        Continue Where I Left Off
      </button>
    </div>
  </div>
</div>

<!-- PS101 Flow Container -->
<section id="ps101-flow" class="ps101-container hidden" aria-label="PS101 Coaching Flow">
  <!-- Progress indicator -->
  <div class="ps101-progress" role="navigation" aria-label="Progress">
    <div class="progress-header">
      <span class="step-label" id="step-label">Step 1 of 10: Problem Identification and Delta Analysis</span>
    </div>
    <div class="progress-dots">
      <button class="dot active" aria-label="Step 1: Problem Identification and Delta Analysis (current)" aria-current="step" data-step="1">1</button>
      <button class="dot" aria-label="Step 2: Current Situation Analysis" data-step="2">2</button>
      <button class="dot" aria-label="Step 3: Root Cause Exploration" data-step="3">3</button>
      <button class="dot" aria-label="Step 4: Self-Efficacy Assessment" data-step="4">4</button>
      <button class="dot" aria-label="Step 5: Solution Brainstorming" data-step="5">5</button>
      <button class="dot" aria-label="Step 6: Experimental Design" data-step="6">6</button>
      <button class="dot" aria-label="Step 7: Obstacle Identification" data-step="7">7</button>
      <button class="dot" aria-label="Step 8: Action Planning" data-step="8">8</button>
      <button class="dot" aria-label="Step 9: Reflection and Iteration" data-step="9">9</button>
      <button class="dot" aria-label="Step 10: Building Mastery and Self-Efficacy" data-step="10">10</button>
    </div>
  </div>

  <!-- Previous answers (expandable) -->
  <details class="previous-answers hidden" id="previous-answers">
    <summary>
      <span class="summary-text">‚ñº Previous Answers (0 steps completed)</span>
      <span class="summary-hint">Click to review or edit</span>
    </summary>
    <div class="answer-list"></div>
  </details>

  <!-- Current step question -->
  <div class="ps101-question" id="ps101-question">
    <h2 class="question-text" id="question-text">
      <!-- Dynamic: Current step question -->
    </h2>

    <!-- Optional coaching hint -->
    <details class="coaching-hint" id="coaching-hint">
      <summary>üí° Coaching Hint</summary>
      <p id="hint-text">
        <!-- Dynamic: Step-specific guidance -->
      </p>
    </details>
  </div>

  <!-- User input area -->
  <div class="ps101-input" id="ps101-input">
    <textarea
      id="step-answer"
      class="step-textarea"
      placeholder="Type your answer here..."
      aria-label="Your answer"
      rows="6"
    ></textarea>
    <div class="char-count" id="char-count" aria-live="polite">
      <span id="char-current">0</span> / <span id="char-max">500</span>
    </div>
  </div>

  <!-- Experiment Components (Steps 6-9) -->
  <div class="experiment-components hidden" id="experiment-components">
    <!-- Step 6: Experiment Canvas -->
    <div class="experiment-canvas hidden" id="experiment-canvas">
      <h3 class="component-title">Experiment Design</h3>
      <div class="experiment-form">
        <div class="form-group">
          <label for="exp-hypothesis">Hypothesis</label>
          <textarea id="exp-hypothesis" rows="3" placeholder="What are you testing?"></textarea>
        </div>
        <div class="form-group">
          <label for="exp-success-metric">Success Metric</label>
          <input type="text" id="exp-success-metric" placeholder="What measurable outcome indicates success?">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="exp-start-date">Start Date</label>
            <input type="date" id="exp-start-date">
          </div>
          <div class="form-group">
            <label for="exp-review-date">Review Date</label>
            <input type="date" id="exp-review-date">
          </div>
        </div>
        <div class="form-group">
          <label for="exp-resources">Resources/Support Needed</label>
          <textarea id="exp-resources" rows="2" placeholder="What do you need to run this experiment?"></textarea>
        </div>
      </div>
    </div>

    <!-- Step 7: Obstacle Mapping -->
    <div class="obstacle-mapping hidden" id="obstacle-mapping">
      <h3 class="component-title">Obstacle Identification</h3>
      <div id="obstacles-list"></div>
      <button class="btn-add" id="add-obstacle-btn">+ Add Obstacle</button>
      <!-- Add Obstacle Form (hidden by default) -->
      <div id="add-obstacle-form" class="hidden add-form-container">
        <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--fg);">Add Obstacle</h4>
        <div class="form-group">
          <label for="obstacle-label">What obstacle do you anticipate? *</label>
          <input
            type="text"
            id="obstacle-label"
            placeholder="e.g., Limited time availability"
            aria-required="true"
            aria-describedby="obstacle-label-error"
          />
          <span id="obstacle-label-error" class="form-error hidden" role="alert"></span>
        </div>
        <div class="form-group">
          <label style="margin-bottom: 8px;">Obstacle Type</label>
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: normal; text-transform: none; letter-spacing: normal;">
            <input type="radio" name="obstacle-type" value="external" checked />
            External (e.g., time, resources, other people)
          </label>
          <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; text-transform: none; letter-spacing: normal;">
            <input type="radio" name="obstacle-type" value="internal" />
            Internal (e.g., self-doubt, fear, lack of knowledge)
          </label>
        </div>
        <div class="form-group">
          <label for="obstacle-strategy">Strategy to overcome this obstacle *</label>
          <textarea
            id="obstacle-strategy"
            rows="3"
            placeholder="How will you mitigate this?"
            aria-required="true"
            aria-describedby="obstacle-strategy-error"
          ></textarea>
          <span id="obstacle-strategy-error" class="form-error hidden" role="alert"></span>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <button id="save-obstacle-btn" class="quiet" style="flex: 1;">Add Obstacle</button>
          <button id="cancel-obstacle-btn" class="quiet" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Step 8: Action Plan -->
    <div class="action-plan hidden" id="action-plan">
      <h3 class="component-title">Action Plan</h3>
      <div id="actions-list"></div>
      <button class="btn-add" id="add-action-btn">+ Add Action Item</button>
      <!-- Add Action Form (hidden by default) -->
      <div id="add-action-form" class="hidden add-form-container">
        <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--fg);">Add Action Item</h4>
        <div class="form-group">
          <label for="action-label">What action will you take? *</label>
          <input
            type="text"
            id="action-label"
            placeholder="e.g., Schedule 30-min focus block daily"
            aria-required="true"
            aria-describedby="action-label-error"
          />
          <span id="action-label-error" class="form-error hidden" role="alert"></span>
        </div>
        <div class="form-group">
          <label for="action-due">By when?</label>
          <input
            type="text"
            id="action-due"
            placeholder="e.g., 2025-11-15 or 'Next Friday'"
          />
        </div>
        <div class="form-group">
          <label for="action-accountability">Who can help hold you accountable? (optional)</label>
          <input
            type="text"
            id="action-accountability"
            placeholder="e.g., My mentor, Team lead"
          />
        </div>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <button id="save-action-btn" class="quiet" style="flex: 1;">Add Action</button>
          <button id="cancel-action-btn" class="quiet" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Step 9: Reflection Log -->
    <div class="reflection-log hidden" id="reflection-log">
      <h3 class="component-title">Reflection & Learning</h3>
      <div class="form-group">
        <label for="reflection-outcome">Outcomes</label>
        <textarea id="reflection-outcome" rows="4" placeholder="What were the results of your experiment?"></textarea>
      </div>
      <div class="form-group">
        <label for="reflection-learning">Learning Summary</label>
        <textarea id="reflection-learning" rows="4" placeholder="What did you learn?"></textarea>
      </div>
      <div class="form-group">
        <label for="reflection-confidence">Confidence After (1-10)</label>
        <input type="range" id="reflection-confidence" min="1" max="10" value="5">
        <span id="confidence-value">5</span>
      </div>
      <div class="form-group">
        <label for="reflection-next-move">Next Move</label>
        <select id="reflection-next-move">
          <option value="Continue">Continue</option>
          <option value="Pivot">Pivot</option>
          <option value="Archive">Archive</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="ps101-nav">
    <button class="nav-btn nav-back quiet" id="ps101-back" aria-label="Go back to previous step">
      ‚Üê Back
    </button>

    <button class="nav-btn nav-next quiet" id="ps101-next" aria-label="Continue to next step">
      Next ‚Üí
    </button>
  </div>

  <!-- Auto-save indicator -->
  <div class="autosave-indicator" id="autosave-indicator" aria-live="polite">
    <span class="autosave-text">Saved</span>
  </div>
</section>

<!-- PS101 Completion Screen -->
<div class="ps101-completion hidden" id="ps101-completion">
  <div class="completion-header">
    <h2 class="completion-title">PS101 Complete ‚Äî Your Action Plan</h2>
    <div class="completion-progress">
      ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè
      <span class="completion-label">All 10 steps completed</span>
    </div>
  </div>

  <div class="completion-message">
    <p>Well done! You've created a clear action plan.</p>
  </div>

  <!-- Highlighted commitment -->
  <div class="commitment-highlight">
    <h3 class="commitment-label">Your Next Commitment (Step 7):</h3>
    <div class="commitment-text" id="commitment-text">
      <!-- Dynamic: User's Step 7 answer -->
    </div>
    <div class="commitment-deadline" id="commitment-deadline">
      <!-- Dynamic: Deadline if provided -->
    </div>
  </div>
</div>

<script>
// Force cache clear - remove after deployment
if(!sessionStorage.getItem('cache_cleared_v3')){
  localStorage.clear();
  sessionStorage.setItem('cache_cleared_v3', '1');
  console.log('Cache cleared');
}

(function(){
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  const SESSION_KEY = 'delta_session_id';
  const AUTO = 'delta_auto_v2';
  const SEEN = 'delta_seen_intro_v1';
  const USER_DATA_KEY = 'delta_user_data';
  const TRIAL_START_KEY = 'delta_trial_start';
  const TRIAL_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
  let sessionId = localStorage.getItem(SESSION_KEY) || '';
  let apiBase = '';
  let configPromise = null;
  let jobCache = [];
  let selectedJobId = null;
  let lastResumeDraft = '';
  let userData = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '{}');
  let autoSaveInterval = null;
  let isAuthenticated = false;
  let currentUser = null;
  let trialStartTime = localStorage.getItem(TRIAL_START_KEY);

  if(sessionId) {
    document.body.dataset.session = sessionId;
  }

  const chat = $('#chat');
  const chatLog = $('#chatLog');
  const chatInput = $('#chatInput');
  const sendMsg = $('#sendMsg');
  const modal = $('#uploadModal');
  const filePick = $('#filePick');
  const uploadStatus = $('#uploadStatus');
  const jobsButton = $('#findOpportunities');
  const jobsStatus = $('#jobsStatus');
  const jobsList = $('#jobsList');
  const resumeRewriteBtn = $('#resumeRewrite');
  const resumeCustomizeBtn = $('#resumeCustomize');
  const resumeFeedbackBtn = $('#resumeFeedback');
  const resumeStatus = $('#resumeStatus');
  const resumeOutput = $('#resumeOutput');
  const jobsButtonLabel = jobsButton ? jobsButton.textContent.trim() : '';
  const status = $('#status');

  $('#y').textContent = new Date().getFullYear();

  function setStatus(el, msg, kind='info'){
    if(!el) return;
    el.textContent = msg || '';
    el.classList.remove('error','ok');
    if(!msg) return;
    if(kind === 'error') el.classList.add('error');
    else if(kind === 'ok') el.classList.add('ok');
  }

  function setSession(id){
    if(!id) return;
    sessionId = id;
    localStorage.setItem(SESSION_KEY, id);
    document.body.dataset.session = id;
    startAutoSave();
  }

  function saveUserData(data){
    userData = {...userData, ...data};
    localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
  }

  function startAutoSave(){
    if(autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(() => {
      if(sessionId && userData){
        // Auto-save user progress every 30 seconds
        saveUserData({
          lastActivity: new Date().toISOString(),
          sessionId: sessionId
        });
      }
    }, 30000);
  }

  // Self-Efficacy Metrics Toggle
  let showNewMetrics = false;
  $('#toggleMetrics').addEventListener('click', () => {
    showNewMetrics = !showNewMetrics;
    const legacyMetrics = $('#legacyMetrics');
    const newMetrics = $('#newMetrics');
    const toggleButton = $('#toggleMetrics');
    
    if(showNewMetrics) {
      legacyMetrics.style.display = 'none';
      newMetrics.style.display = 'block';
      toggleButton.textContent = 'show legacy metrics';
      // Load new metrics data
      loadSelfEfficacyMetrics();
    } else {
      legacyMetrics.style.display = 'block';
      newMetrics.style.display = 'none';
      toggleButton.textContent = 'show new metrics';
    }
  });

  // Load Self-Efficacy Metrics
  async function loadSelfEfficacyMetrics() {
    if(!sessionId) return;
    
    try {
      const response = await fetch(`${apiBase}/self-efficacy/metrics`, {
        headers: { 'X-Session-ID': sessionId }
      });
      
      if(response.ok) {
        const data = await response.json();
        updateMetricsDisplay(data);
        
        // Check for escalation
        const escalationResponse = await fetch(`${apiBase}/self-efficacy/escalation`, {
          headers: { 'X-Session-ID': sessionId }
        });
        
        if(escalationResponse.ok) {
          const escalationData = await escalationResponse.json();
          updateEscalationDisplay(escalationData);
        }
      }
    } catch(error) {
      console.error('Error loading self-efficacy metrics:', error);
    }
  }

  // Update Metrics Display
  function updateMetricsDisplay(data) {
    const completionRate = (data.experiment_completion_rate * 100).toFixed(1);
    const learningVelocity = data.learning_velocity.toFixed(2);
    const confidenceScore = (data.confidence_score * 100).toFixed(1);
    const escalationRisk = (data.escalation_risk * 100).toFixed(1);
    
    $('#completionRate').textContent = `${data.completed_experiments}/${data.total_experiments} (${completionRate}%)`;
    $('#learningVelocity').textContent = `${learningVelocity} events/day`;
    $('#confidenceScore').textContent = `${confidenceScore}%`;
    $('#escalationRisk').textContent = `${escalationRisk}%`;
    
    // Color coding based on values
    const completionEl = $('#completionRate');
    const velocityEl = $('#learningVelocity');
    const confidenceEl = $('#confidenceScore');
    const riskEl = $('#escalationRisk');
    
    // Completion rate colors
    if(data.experiment_completion_rate >= 0.8) completionEl.style.color = '#2d7a2d';
    else if(data.experiment_completion_rate >= 0.5) completionEl.style.color = '#b8860b';
    else completionEl.style.color = '#b00020';
    
    // Learning velocity colors
    if(data.learning_velocity >= 1.0) velocityEl.style.color = '#2d7a2d';
    else if(data.learning_velocity >= 0.5) velocityEl.style.color = '#b8860b';
    else velocityEl.style.color = '#b00020';
    
    // Confidence score colors
    if(data.confidence_score >= 0.7) confidenceEl.style.color = '#2d7a2d';
    else if(data.confidence_score >= 0.4) confidenceEl.style.color = '#b8860b';
    else confidenceEl.style.color = '#b00020';
    
    // Escalation risk colors
    if(data.escalation_risk >= 0.7) riskEl.style.color = '#b00020';
    else if(data.escalation_risk >= 0.4) riskEl.style.color = '#b8860b';
    else riskEl.style.color = '#2d7a2d';
  }

  // Update Escalation Display
  function updateEscalationDisplay(data) {
    const escalationAlert = $('#escalationAlert');
    const escalationMessage = $('#escalationMessage');
    
    if(data.should_escalate) {
      escalationAlert.style.display = 'block';
      escalationMessage.textContent = data.reason;
    } else {
      escalationAlert.style.display = 'none';
    }
  }

  function stopAutoSave(){
    if(autoSaveInterval) {
      clearInterval(autoSaveInterval);
      autoSaveInterval = null;
    }
  }

  async function authenticateUser(email, password, isRegister = false, discountCode = null){
    try{
      setStatus($('#authStatus'), 'authenticating...');

      // Enhanced authentication with backend API
      if(isRegister){
        // Registration validation
        if(password.length < 6){
          throw new Error('Password must be at least 6 characters');
        }
        if(!email.includes('@')){
          throw new Error('Please enter a valid email address');
        }

        // Register with backend (include discount code if provided)
        const body = { email, password };
        if(discountCode) body.discount_code = discountCode;

        const response = await callJson('/auth/register', {
          method: 'POST',
          body
        });

        currentUser = {
          id: response.user_id,
          email: response.email,
          createdAt: response.created_at,
          lastLogin: response.last_login,
          subscriptionTier: response.subscription_tier,
          subscriptionStatus: response.subscription_status
        };

        const tierMessage = response.subscription_tier === 'beta' ? ' (beta access granted)' : '';
        setStatus($('#authStatus'), `account created successfully!${tierMessage}`, 'ok');

      } else {
        // Login with backend
        const response = await callJson('/auth/login', {
          method: 'POST',
          body: { email, password }
        });
        
        currentUser = {
          id: response.user_id,
          email: response.email,
          createdAt: response.created_at,
          lastLogin: response.last_login
        };
        
        setStatus($('#authStatus'), 'welcome back!', 'ok');
      }
      
      // Success - set user data
      isAuthenticated = true;
      localStorage.removeItem(TRIAL_START_KEY); // Clear trial
      trialStartTime = null;
      saveUserData({
        user: currentUser,
        authenticated: true,
        loginTime: new Date().toISOString()
      });

      // Hide auth modal, show welcome
      $('#authModal').style.display = 'none';
      $('#welcome').hidden = false;
      $('#logoutBtn').hidden = false;
      updateUserProgress();

      // Start auto-save for authenticated user
      startAutoSave();
      
    }catch(err){
      setStatus($('#authStatus'), err.message, 'error');
    }
  }

  function startTrial(){
    if(!isAuthenticated && !trialStartTime){
      trialStartTime = Date.now().toString();
      localStorage.setItem(TRIAL_START_KEY, trialStartTime);
      setTimeout(checkTrialExpired, TRIAL_DURATION);
    }
  }

  function checkTrialExpired(){
    if(isAuthenticated) return; // User signed up, no need to prompt

    const elapsed = Date.now() - parseInt(trialStartTime);
    if(elapsed >= TRIAL_DURATION){
      showSignUpPrompt();
    }
  }

  function showSignUpPrompt(){
    const authModal = $('#authModal');
    if(authModal){
      authModal.style.display = 'block';
      const authStatus = $('#authStatus');
      if(authStatus){
        setStatus(authStatus, 'trial period ended - sign up to continue', 'info');
      }
    }
  }

  function updateUserProgress(){
    if(currentUser){
      $('#sessionDisplay').textContent = currentUser.email;
      $('#pathDisplay').textContent = userData.path || '-';
      $('#lastActivityDisplay').textContent = userData.lastActivity ? new Date(userData.lastActivity).toLocaleString() : '-';
      $('#userProgress').hidden = false;

      // Update user stats
      const userStats = {
        totalSessions: userData.totalSessions || 1,
        messagesSent: userData.messagesSent || 0,
        filesUploaded: userData.filesUploaded || 0,
        opportunitiesViewed: userData.opportunitiesViewed || 0,
        resumesGenerated: userData.resumesGenerated || 0
      };

      // Save updated stats
      saveUserData(userStats);
    }
  }

  async function logout(){
    console.log('[LOGOUT] Starting logout process...');

    // Store old session ID before clearing
    const oldSessionId = sessionId;
    console.log('[LOGOUT] Session ID:', oldSessionId);

    // Set logout flag in sessionStorage (survives the reload)
    sessionStorage.setItem('LOGGING_OUT', '1');
    console.log('[LOGOUT] Set LOGGING_OUT flag in sessionStorage');

    // Clear ALL localStorage
    localStorage.clear();
    console.log('[LOGOUT] Cleared localStorage');

    // Call backend logout endpoint (fire and forget)
    try {
      await callJson('/auth/logout', {
        method: 'POST',
        headers: oldSessionId ? { 'X-Session-ID': oldSessionId } : {}
      });
      console.log('[LOGOUT] Backend logout API called successfully');
    } catch(err) {
      console.error('[LOGOUT] Logout API error:', err);
    }

    // Reload page - logout flag will be checked on load
    console.log('[LOGOUT] Reloading page...');
    window.location.reload();
  }

  async function ensureConfig(){
    if(apiBase) return apiBase;
    if(configPromise) return configPromise;
    const endpoints = [
      `${window.location.origin}/config`,
      'https://what-is-my-delta-site-production.up.railway.app/config',
      'https://whatismydelta.com/config'
    ];
    configPromise = (async ()=>{
      for(const url of endpoints){
        try{
          const res = await fetch(url, {mode:'cors'});
          if(!res.ok) continue;
          const data = await res.json();
          apiBase = (data.apiBase || new URL(url).origin || '').replace(/\/$/,'');
          if(!apiBase) apiBase = new URL(url).origin;
          document.body.dataset.apiBase = apiBase;
          return apiBase;
        }catch(err){
          // ignore endpoint failure
        }
      }
      apiBase = 'https://what-is-my-delta-site-production.up.railway.app';
      document.body.dataset.apiBase = apiBase;
      return apiBase;
    })();
    return configPromise;
  }

  async function callJson(path, {method='GET', body, headers={}} = {}){
    await ensureConfig();
    const init = {method, headers:{...headers}};
    if(body !== undefined){
      if(body instanceof FormData){
        init.body = body;
      }else{
        init.headers['Content-Type'] = 'application/json';
        init.body = JSON.stringify(body);
      }
    }
    if(sessionId){
      init.headers['X-Session-ID'] = sessionId;
    }
    const res = await fetch(`${apiBase}${path}`, init);
    let data = null;
    try{ data = await res.json(); } catch(err){ data = null; }
    if(!res.ok){
      const message = (data && (data.detail || data.error)) || `request_failed (${res.status})`;
      throw new Error(message);
    }
    if(data && data.session_id) setSession(data.session_id);
    return data || {};
  }

  async function uploadToWimd(file){
    await ensureConfig();
    const headers = {};
    if(sessionId) headers['X-Session-ID'] = sessionId;
    const form = new FormData();
    form.append('file', file);
    const res = await fetch(`${apiBase}/wimd/upload`, {method:'POST', headers, body: form});
    let data = null;
    try{ data = await res.json(); } catch(err){ data = null; }
    if(!res.ok){
      const message = (data && (data.detail || data.error)) || `upload_failed (${res.status})`;
      throw new Error(message);
    }
    if(data && data.session_id) setSession(data.session_id);
    return data;
  }

  function getJob(jobId){
    // Phase 4+ compatibility: Support both job_id and id
    return jobCache.find(item => (item.job_id === jobId || item.id === jobId));
  }

  function highlightSelected(){
    $$('.job-card').forEach(card => {
      card.classList.toggle('selected', card.dataset.jobId === selectedJobId);
    });
  }

  function renderJobs(matches){
    jobCache = Array.isArray(matches) ? matches : [];
    jobsList.innerHTML = '';
    selectedJobId = null;
    if(!jobCache.length){
      setStatus(jobsStatus, 'no opportunities yet ‚Äî keep working the coach flow', 'info');
      const resumeControls = $('#resumeControls');
      if(resumeControls) resumeControls.hidden = true;
      return;
    }
    jobCache.forEach(match=>{
      // Phase 4+ compatibility: Support both old (job_id/role) and new (id/title) formats
      const jobId = match.job_id || match.id;
      const role = match.role || match.title;
      const company = match.company;
      const location = match.location || 'remote';

      // Phase 4+ uses skills array, legacy uses skills_match
      const skillsArr = Array.isArray(match.skills) ? match.skills : (Array.isArray(match.skills_match) ? match.skills_match : []);
      const valuesArr = Array.isArray(match.values_match) ? match.values_match : [];

      // Phase 4+ doesn't provide fit_score, show source instead
      const fit = Math.round(match.fit_score || 0);
      const source = match.source ? `source: ${match.source}` : (fit > 0 ? `fit score: ${fit}%` : '');

      const card = document.createElement('div');
      card.className = 'job-card';
      card.dataset.jobId = jobId;
      card.innerHTML = `
        <div><strong>${role}</strong> ‚Äî ${company}</div>
        <div class="muted">${location}</div>
        ${source ? `<div class="muted">${source}</div>` : ''}
        ${skillsArr.length > 0 ? `
          <div class="muted">skills</div>
          <div>${skillsArr.map(s=>`<span class=\"pill\">${s}</span>`).join(' ')}</div>
        ` : ''}
        ${valuesArr.length > 0 ? `
          <div class="muted">values</div>
          <div>${valuesArr.map(s=>`<span class=\"pill\">${s}</span>`).join(' ')}</div>
        ` : ''}
        <div class="job-actions">
          <button class="quiet job-select" type="button">focus</button>
          <button class="quiet job-apply" type="button">apply</button>
        </div>
      `;
      jobsList.appendChild(card);
    });
    setStatus(jobsStatus, `found ${jobCache.length} opportunities`, 'ok');
    
    // Show resume controls when jobs are available
    const resumeControls = $('#resumeControls');
    if(resumeControls) resumeControls.hidden = false;
  }

  function selectJob(jobId){
    if(!jobId) return;
    selectedJobId = jobId;
    highlightSelected();
    const job = getJob(jobId);
    setStatus(jobsStatus, job ? `focused on ${job.role}` : `focused on ${jobId}`, 'ok');
  }

  function currentResumeSource(){
    if(lastResumeDraft) return lastResumeDraft;
    return '';
  }

  function setResumeOutput(text){
    lastResumeDraft = text || '';
    if(resumeOutput){
      if(lastResumeDraft){
        resumeOutput.textContent = lastResumeDraft;
        resumeOutput.hidden = false;
      }else{
        resumeOutput.hidden = true;
      }
    }
  }

  async function askCoach(prompt){
    const payload = {prompt};
    if(sessionId) payload.session_id = sessionId;
    saveUserData({lastMessage: prompt, timestamp: new Date().toISOString()});
    const data = await callJson('/wimd', {method:'POST', body: payload});

    // Save coach response and metrics
    saveUserData({
      lastCoachResponse: data.message,
      metrics: data.metrics,
      sessionId: data.session_id
    });

    // If this is the first meaningful interaction, show opportunities hint
    if(data.metrics && !userData.hasSeenOpportunities){
      setTimeout(() => {
        setStatus(status, 'ready to explore opportunities?', 'ok');
        saveUserData({hasSeenOpportunities: true});
      }, 2000);
    }

    return data.message || 'noted.';
  }

  async function startPS101(){
    const headers = {};
    if(sessionId) headers['X-Session-ID'] = sessionId;
    const data = await callJson('/wimd/start-ps101', {method:'POST', headers});

    // Save session info
    if(!sessionId && data.session_id){
      sessionId = data.session_id;
      saveUserData({sessionId: data.session_id});
    }

    saveUserData({
      path: 'fastTrack',
      ps101Active: true,
      started: new Date().toISOString()
    });

    return data.message || 'Starting PS101 guided sequence...';
  }

  async function fetchOpportunities(){
    // Phase 4+: Use new job search endpoint with RAG
    const query = userData.careerGoal || userData.lastCoachResponse || 'software engineer';

    try {
      const data = await callJson(`/jobs/search?query=${encodeURIComponent(query)}&limit=10`);
      renderJobs(data.jobs || []);

      // Show feedback about sources used
      if(data.sources_used && data.sources_used.length > 0){
        setStatus(jobsStatus, `found ${data.total_results || 0} opportunities from ${data.sources_used.length} sources`, 'ok');
      }
    } catch(err) {
      // Fallback to legacy endpoint if Phase 4+ not enabled
      if(sessionId){
        const data = await callJson('/ob/opportunities');
        renderJobs(data.opportunities || []);
      } else {
        throw new Error('start with the coach to unlock matches');
      }
    }
  }

  async function applyForJob(jobId, notes=''){
    const data = await callJson('/ob/apply', {
      method:'POST',
      body: {job_id: jobId, notes},
    });
    const job = getJob(jobId);
    if(job){
      job.extras = job.extras || {};
      job.extras.status = 'applied';
    }
    const card = jobsList.querySelector(`.job-card[data-job-id="${jobId}"]`);
    if(card){
      card.classList.add('applied');
    }
    return data;
  }

  async function rewriteResume(jobId, source){
    const body = {};
    if(sessionId) body.session_id = sessionId;
    if(jobId) body.job_id = jobId;
    if(source) body.source_resume = source;
    const data = await callJson('/resume/rewrite', {method:'POST', body});
    setResumeOutput(data.resume || '');
    return data;
  }

  async function customizeResume(jobId, source, job){
    if(!jobId) throw new Error('select an opportunity first');
    if(!source) throw new Error('add resume content first');
    const body = {
      job_id: jobId,
      resume: source,
      highlight_skills: Array.isArray(job?.skills_match) ? job.skills_match : [],
    };
    if(sessionId) body.session_id = sessionId;
    const data = await callJson('/resume/customize', {method:'POST', body});
    setResumeOutput(data.resume || '');
    return data;
  }

  async function resumeFeedback(source){
    if(!source) throw new Error('need a resume draft first');
    const body = {resume: source};
    if(sessionId) body.session_id = sessionId;
    const data = await callJson('/resume/feedback', {method:'POST', body});
    return data;
  }

  ensureConfig().then(()=>{
    if(sessionId){
      callJson('/wimd/metrics').catch(()=>{});
    }
  }).catch(()=>{});

  // Authentication event handlers
  const loginForm = $('#loginForm');
  if(loginForm){
    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const email = $('#loginEmail').value;
      const password = $('#loginPassword').value;
      await authenticateUser(email, password, false);
    });
  }

  const registerForm = $('#registerForm');
  if(registerForm){
    registerForm.addEventListener('submit', async e => {
      e.preventDefault();
      const email = $('#registerEmail').value;
      const password = $('#registerPassword').value;
      const confirm = $('#registerConfirm').value;
      const discountCode = $('#registerDiscountCode')?.value?.trim() || null;

      if(password !== confirm){
        setStatus($('#authStatus'), 'passwords do not match', 'error');
        return;
      }

      await authenticateUser(email, password, true, discountCode);
    });
  }

  const toggleAuth = $('#toggleAuth');
  if(toggleAuth){
    toggleAuth.addEventListener('click', e => {
      e.preventDefault();
      const loginForm = $('#loginForm');
      const registerForm = $('#registerForm');
      const isLogin = !loginForm.hidden;

      if(isLogin){
        loginForm.hidden = true;
        registerForm.hidden = false;
        toggleAuth.textContent = 'already have an account?';
      } else {
        loginForm.hidden = false;
        registerForm.hidden = true;
        toggleAuth.textContent = 'need an account?';
      }
    });
  }

  const clearSession = $('#clearSession');
  if(clearSession){
    clearSession.addEventListener('click', e => {
      e.preventDefault();
      logout();
    });
  }

  const logoutBtn = $('#logoutBtn');
  if(logoutBtn){
    logoutBtn.addEventListener('click', e => {
      e.preventDefault();
      logout();
    });
  }

  // Password reset
  const forgotPassword = $('#forgotPassword');
  const resetModal = $('#resetModal');
  const resetForm = $('#resetForm');
  const closeReset = $('#closeReset');

  if(forgotPassword){
    forgotPassword.addEventListener('click', e => {
      e.preventDefault();
      resetModal.style.display = 'flex';
    });
  }

  if(closeReset){
    closeReset.addEventListener('click', () => {
      resetModal.style.display = 'none';
      $('#resetStatus').textContent = '';
      $('#resetEmail').value = '';
    });
  }

  if(resetForm){
    resetForm.addEventListener('submit', async e => {
      e.preventDefault();
      const email = $('#resetEmail').value;
      const resetStatus = $('#resetStatus');

      setStatus(resetStatus, 'sending reset link...');

      try {
        const response = await fetch(`${apiBase}/auth/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await response.json();

        if(response.ok){
          setStatus(resetStatus, 'password reset link sent to your email', 'ok');
          setTimeout(() => {
            resetModal.style.display = 'none';
            $('#resetStatus').textContent = '';
            $('#resetEmail').value = '';
          }, 3000);
        } else {
          setStatus(resetStatus, data.detail || 'reset failed', 'error');
        }
      } catch(error){
        setStatus(resetStatus, 'network error - try again', 'error');
      }
    });
  }

  const showGuide = $('#showGuide');
  if(showGuide){
    showGuide.addEventListener('click', e => {
      e.preventDefault();
      $('#userGuide').hidden = false;
    });
  }

  const hideGuide = $('#hideGuide');
  if(hideGuide){
    hideGuide.addEventListener('click', e => {
      e.preventDefault();
      $('#userGuide').hidden = true;
    });
  }

  const openChat = $('#openChat');
  if(openChat){
    openChat.addEventListener('click', e=>{
      e.preventDefault();
      if(chat) chat.style.display='block';
    });
  }

  const closeChat = $('#closeChat');
  if(closeChat){
    closeChat.addEventListener('click', ()=>{
      if(chat) chat.style.display='none';
    });
  }

  // Welcome onboarding buttons
  const startPS101Btn = $('#startPS101');
  if(startPS101Btn){
    startPS101Btn.addEventListener('click', async e=>{
      e.preventDefault();
      $('#welcome').hidden = true;
      chat.style.display='block';
      // TODO: Implement full PS101 10-step flow
      addMsg('PS101 problem-solving flow coming soon. For now, let\'s start with understanding your career challenge. What brings you here today?', 'bot');
      saveUserData({path: 'ps101_stub', started: new Date().toISOString()});
    });
  }

  const startChatBtn = $('#startChat');
  if(startChatBtn){
    startChatBtn.addEventListener('click', e=>{
      e.preventDefault();
      $('#welcome').hidden = true;
      chat.style.display='block';
      addMsg('Welcome! I\'m your career coach. Tell me about your career situation ‚Äî what are you looking to achieve?', 'bot');
      saveUserData({path: 'chat', started: new Date().toISOString()});
    });
  }

  const startDiscoveryFlow = $('#startDiscoveryFlow');
  console.log('startDiscoveryFlow element:', startDiscoveryFlow);
  if(startDiscoveryFlow){
    startDiscoveryFlow.addEventListener('click', e=>{
      console.log('EXPLORE button clicked!');
      e.preventDefault();
      saveUserData({path: 'discovery', started: new Date().toISOString()});
      console.log('chat element:', chat, 'display:', chat ? chat.style.display : 'no chat');
      if(chat) chat.style.display='block';
      addMsg('hi ‚Äî let\'s start your career discovery. what are you looking to explore in your career transition?', 'bot');
    });
    console.log('startDiscoveryFlow event listener attached');
  } else {
    console.log('ERROR: startDiscoveryFlow element not found!');
  }

  // Circular flow buttons
  const exploreCircle = $('#exploreCircle');
  if(exploreCircle){
    exploreCircle.addEventListener('click', e => {
      e.preventDefault();
      saveUserData({path: 'discovery', started: new Date().toISOString()});
      if(chat) chat.style.display='block';
      addMsg('hi ‚Äî let\'s start your career discovery. what are you looking to explore in your career transition?', 'bot');
    });
  }

  const findCircle = $('#findCircle');
  if(findCircle){
    findCircle.addEventListener('click', async e => {
      e.preventDefault();
      setStatus(jobsStatus, 'finding opportunities...');
      try {
        await fetchOpportunities();
      } catch(err) {
        setStatus(jobsStatus, err.message, 'error');
      }
    });
  }

  const applyCircle = $('#applyCircle');
  if(applyCircle){
    applyCircle.addEventListener('click', e => {
      e.preventDefault();

      // Check if jobs are loaded first
      if(!jobCache || jobCache.length === 0){
        setStatus(resumeStatus, 'find jobs first before using resume tools', 'error');
        return;
      }

      // Show and scroll to resume tools section
      const resumeSection = $('#resumeControls');
      if(resumeSection){
        resumeSection.hidden = false;
        resumeSection.scrollIntoView({behavior: 'smooth', block: 'start'});

        // Highlight the section briefly
        resumeSection.style.border = '2px solid #2d7a2d';
        setTimeout(() => {
          resumeSection.style.border = '1px solid var(--line)';
        }, 2000);

        // Guide the user
        if(selectedJobId){
          setStatus(resumeStatus, `ready to customize resume for selected job`, 'ok');
        } else {
          setStatus(resumeStatus, 'select a job below, then use rewrite/customize/feedback buttons', 'info');
        }
      }
    });
  }

  // Add missing event handlers for the new interface
  if(jobsButton){
    jobsButton.addEventListener('click', async e => {
      e.preventDefault();
      setStatus(jobsStatus, 'finding opportunities...');
      try {
        await fetchOpportunities();
      } catch(err) {
        setStatus(jobsStatus, err.message, 'error');
      }
    });
  }

  if(resumeRewriteBtn){
    resumeRewriteBtn.addEventListener('click', async e => {
      e.preventDefault();
      setStatus(resumeStatus, 'rewriting resume...');
      try {
        const data = await rewriteResume(selectedJobId, '');
        setStatus(resumeStatus, `resume rewritten`, 'ok');
      } catch(err) {
        setStatus(resumeStatus, err.message, 'error');
      }
    });
  }

  function addMsg(txt, who='you'){
    if(!chatLog) return;
    const div = document.createElement('div');
    div.className = 'msg';
    div.textContent = (who==='you'?'> ':'') + txt;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  async function send(){
    if(!chatInput) return;
    const v = (chatInput.value || '').trim();
    if(!v) return;
    addMsg(v, 'you');
    chatInput.value = '';
    try{
      const r = await askCoach(v);
      addMsg(r, 'bot');
    }catch(err){
      addMsg(err.message || '‚Ä¶connection issue', 'bot');
    }
  }

  if(chatInput){
    chatInput.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        send();
      }
    });
  }
  if(sendMsg){
    sendMsg.addEventListener('click', send);
  }

  $('#openUpload').addEventListener('click', e=>{
    e.preventDefault();
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  });

  // Handle flow section upload button
  $('#openUploadFlow').addEventListener('click', e=>{
    e.preventDefault();
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  });
  $('#closeUpload').addEventListener('click', ()=>{
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    setStatus(uploadStatus, '');
  });

  if(filePick){
    filePick.addEventListener('change', async e=>{
      const file = (e.target.files || [])[0];
      if(!file) return;
      try{
        setStatus(uploadStatus, `uploading ${file.name}‚Ä¶`);
        await uploadToWimd(file);
        setStatus(uploadStatus, `${file.name} uploaded`, 'ok');
      }catch(err){
        setStatus(uploadStatus, err.message, 'error');
      }finally{
        e.target.value = '';
      }
    });
  }

  if(jobsButton){
    jobsButton.addEventListener('click', async e=>{
      e.preventDefault();
      jobsButton.classList.add('loading');
      jobsButton.textContent = 'finding‚Ä¶';
      setStatus(jobsStatus, '');
      try{
        await fetchOpportunities();
      }catch(err){
        setStatus(jobsStatus, err.message, 'error');
      }finally{
        jobsButton.classList.remove('loading');
        jobsButton.textContent = jobsButtonLabel || 'find opportunities';
      }
    });
  }

  if(jobsList){
    jobsList.addEventListener('click', async e=>{
      const card = e.target.closest('.job-card');
      if(!card) return;
      const jobId = card.dataset.jobId;
      if(e.target.classList.contains('job-select')){
        selectJob(jobId);
        return;
      }
      if(e.target.classList.contains('job-apply')){
        e.preventDefault();
        card.classList.add('loading');
        try{
          const data = await applyForJob(jobId);
          selectJob(jobId);
          setStatus(jobsStatus, `applied to ${data.job?.role || jobId}`, 'ok');
        }catch(err){
          setStatus(jobsStatus, err.message, 'error');
        }finally{
          card.classList.remove('loading');
        }
      }
    });
  }

  if(resumeRewriteBtn){
    resumeRewriteBtn.addEventListener('click', async e=>{
      e.preventDefault();
      const source = currentResumeSource();
      resumeRewriteBtn.classList.add('loading');
      setStatus(resumeStatus, 'rewriting‚Ä¶');
      try{
        const data = await rewriteResume(selectedJobId, source);
        setStatus(resumeStatus, `saved ${data.version_name}`, 'ok');
      }catch(err){
        setStatus(resumeStatus, err.message, 'error');
      }finally{
        resumeRewriteBtn.classList.remove('loading');
      }
    });
  }

  if(resumeCustomizeBtn){
    resumeCustomizeBtn.addEventListener('click', async e=>{
      e.preventDefault();
      const job = getJob(selectedJobId);
      const source = currentResumeSource();
      resumeCustomizeBtn.classList.add('loading');
      setStatus(resumeStatus, 'customizing‚Ä¶');
      try{
        const data = await customizeResume(selectedJobId, source, job);
        setStatus(resumeStatus, `customized for ${data.version_name}`, 'ok');
      }catch(err){
        setStatus(resumeStatus, err.message, 'error');
      }finally{
        resumeCustomizeBtn.classList.remove('loading');
      }
    });
  }

  if(resumeFeedbackBtn){
    resumeFeedbackBtn.addEventListener('click', async e=>{
      e.preventDefault();
      const source = currentResumeSource();
      resumeFeedbackBtn.classList.add('loading');
      setStatus(resumeStatus, 'scanning draft‚Ä¶');
      try{
        const data = await resumeFeedback(source);
        const suggestions = data.suggestions || [];
        setStatus(resumeStatus, suggestions.length ? suggestions.join(' ‚Ä¢ ') : 'no changes suggested', 'ok');
      }catch(err){
        setStatus(resumeStatus, err.message, 'error');
      }finally{
        resumeFeedbackBtn.classList.remove('loading');
      }
    });
  }

  // Check if we just logged out (flag set in sessionStorage)
  const loggingOutFlag = sessionStorage.getItem('LOGGING_OUT');
  console.log('[PAGE LOAD] Checking LOGGING_OUT flag:', loggingOutFlag);

  if(loggingOutFlag){
    console.log('[PAGE LOAD] LOGGING_OUT flag detected - executing clean state');

    // Clear the flag
    sessionStorage.removeItem('LOGGING_OUT');
    console.log('[PAGE LOAD] Removed LOGGING_OUT flag');

    // Force clean state - don't restore anything
    isAuthenticated = false;
    currentUser = null;
    sessionId = '';
    userData = {};
    localStorage.clear();
    console.log('[PAGE LOAD] Cleared all state variables and localStorage');

    // Clear chat UI
    const chatLog = $('#chatLog');
    if(chatLog){
      console.log('[PAGE LOAD] Clearing chat log, current content:', chatLog.innerHTML.substring(0, 100));
      chatLog.innerHTML = '';
      console.log('[PAGE LOAD] Chat log cleared');
    } else {
      console.log('[PAGE LOAD] WARNING: chatLog element not found!');
    }

    if(chat){
      chat.style.display = 'none';
      console.log('[PAGE LOAD] Hidden chat panel');
    }

    // Show auth modal
    $('#authModal').style.display = 'block';
    $('#welcome').hidden = true;
    $('#userProgress').hidden = true;
    $('#logoutBtn').hidden = true;
    console.log('[PAGE LOAD] Reset UI to login state');

    // Don't run any auto-login or welcome message logic
    console.log('[PAGE LOAD] Logout cleanup complete - skipping normal auth restore');
  } else {
    console.log('[PAGE LOAD] Normal page load - no LOGGING_OUT flag');
    // Normal page load - check for existing authentication
    if(userData.authenticated && userData.user){
      currentUser = userData.user;
      isAuthenticated = true;
      $('#authModal').style.display = 'none';
      $('#welcome').hidden = false;
      $('#logoutBtn').hidden = false;
      updateUserProgress();

      // Ensure chat functionality is enabled for authenticated users
      if(chat && chatInput && sendMsg){
        // Chat is ready - make sure event listeners are working
        console.log('Chat initialized for authenticated user');
      }
    }

    if(!localStorage.getItem(SEEN) && isAuthenticated){
      chat.style.display = 'block';
      addMsg('hi ‚Äî let\'s work on your career transition. what would you like to explore?', 'bot');
      localStorage.setItem(SEEN, '1');
    }
  }

  // Start trial mode for unauthenticated users
  if(!isAuthenticated){
    startTrial();

    // Check if trial already expired
    if(trialStartTime){
      const elapsed = Date.now() - parseInt(trialStartTime);
      if(elapsed >= TRIAL_DURATION){
        showSignUpPrompt();
      } else {
        // Set timeout for remaining time
        setTimeout(checkTrialExpired, TRIAL_DURATION - elapsed);
      }
    }
  }

  // Draggable windows functionality (minimal, mobile-aware)
  const makeWindowDraggable = (el) => {
    if(!el || window.innerWidth < 768) return;
    const header = el.querySelector('[data-drag-handle]') || el.querySelector('header');
    if(!header) return;
    let pos = {x: 0, y: 0, startX: 0, startY: 0};
    header.style.cursor = 'move';
    header.onmousedown = (e) => {
      e.preventDefault();
      pos.startX = e.clientX;
      pos.startY = e.clientY;
      document.onmousemove = drag;
      document.onmouseup = stopDrag;
    };
    const drag = (e) => {
      pos.x = pos.startX - e.clientX;
      pos.y = pos.startY - e.clientY;
      pos.startX = e.clientX;
      pos.startY = e.clientY;
      const newTop = (el.offsetTop - pos.y);
      const newLeft = (el.offsetLeft - pos.x);
      if(newTop >= 0 && newTop + el.offsetHeight <= window.innerHeight){
        el.style.top = newTop + 'px';
      }
      if(newLeft >= 0 && newLeft + el.offsetWidth <= window.innerWidth){
        el.style.left = newLeft + 'px';
      }
    };
    const stopDrag = () => {
      document.onmousemove = null;
      document.onmouseup = null;
    };
  };

  // Make chat draggable (if it exists and is fixed position)
  if(chat && window.innerWidth >= 768){
    chat.style.position = 'fixed';
    makeWindowDraggable(chat);
  }

  // ========================================
  // PS101 v2 Flow Manager
  // ========================================

  const ps101Steps = [
    {
      step: 1,
      title: "Problem Identification and Delta Analysis",
      prompts: [
        "What specific career challenge or problem are you facing right now?",
        "Describe where you are currently in your career and where you'd like to be."
      ],
      minChars: 30,
      maxChars: 500
    },
    {
      step: 2,
      title: "Current Situation Analysis",
      prompts: [
        "Describe your current situation in detail. What are the facts?",
        "What have you already tried to address this problem?"
      ],
      minChars: 30,
      maxChars: 500
    },
    {
      step: 3,
      title: "Root Cause Exploration",
      prompts: [
        "What do you think is the root cause of this problem?",
        "What patterns or themes do you notice in this situation?"
      ],
      minChars: 30,
      maxChars: 500
    },
    {
      step: 4,
      title: "Self-Efficacy Assessment",
      prompts: [
        "On a scale of 1-10, how confident do you feel about solving this problem?",
        "What makes you feel that way? What evidence do you have for this confidence level?"
      ],
      minChars: 10,
      maxChars: 500
    },
    {
      step: 5,
      title: "Solution Brainstorming",
      prompts: [
        "List 3-5 possible approaches you could take to solve this problem.",
        "For each approach, what is one concrete first step you could take?"
      ],
      minChars: 30,
      maxChars: 500
    },
    {
      step: 6,
      title: "Experimental Design",
      prompts: [
        "Which approach from your brainstorm do you want to try first as an experiment?",
        "What would success look like for this experiment?"
      ],
      minChars: 30,
      maxChars: 500
    },
    {
      step: 7,
      title: "Obstacle Identification",
      prompts: [
        "What obstacles might prevent you from completing this experiment?",
        "For each obstacle, what is one strategy you could use to overcome it?"
      ],
      minChars: 30,
      maxChars: 500
    },
    {
      step: 8,
      title: "Action Planning",
      prompts: [
        "What are the specific action steps you'll take to run this experiment?",
        "When will you complete each action? Who can help hold you accountable?"
      ],
      minChars: 30,
      maxChars: 500
    },
    {
      step: 9,
      title: "Reflection and Iteration",
      prompts: [
        "After running your experiment, what were the results?",
        "What did you learn? What will you do next: continue, pivot, or try something new?"
      ],
      minChars: 30,
      maxChars: 500
    },
    {
      step: 10,
      title: "Building Mastery and Self-Efficacy",
      prompts: [
        "Reflecting on this problem-solving process, what new skills or knowledge have you gained?",
        "How can you apply what you've learned to future challenges or goals?",
        "What strategies will you use to maintain momentum and continue building your problem-solving abilities?",
        "How has this experience changed your perception of your own capabilities?"
      ],
      minChars: 30,
      maxChars: 1000
    }
  ];

  // State Object (v2 - multi-prompt + experiments)
  const PS101State = {
    currentStep: 1,
    currentPromptIndex: 0,
    steps: {}, // { "1": { prompts: [{ response: "...", completedAt: "..." }] } }
    experiments: [], // Array of experiment objects
    startedAt: null,
    lastUpdated: null,
    completed: false,
    completionScores: {},

    init() {
      const saved = localStorage.getItem('ps101_state_v2');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          Object.assign(this, parsed);
        } catch (e) {
          console.error('[PS101] Failed to parse saved state', e);
        }
      }
      if (!this.startedAt) this.startedAt = new Date().toISOString();
    },

    save() {
      this.lastUpdated = new Date().toISOString();
      localStorage.setItem('ps101_state_v2', JSON.stringify(this));
    },

    reset() {
      localStorage.removeItem('ps101_state_v2');
      this.currentStep = 1;
      this.currentPromptIndex = 0;
      this.steps = {};
      this.experiments = [];
      this.startedAt = new Date().toISOString();
      this.lastUpdated = null;
      this.completed = false;
      this.completionScores = {};
      this.save();
    },

    goToStep(stepNumber) {
      this.currentStep = stepNumber;
      this.currentPromptIndex = 0;
      this.save();
    },

    getAnswer(stepNumber, promptIndex) {
      if (!this.steps[stepNumber]) return '';
      const prompts = this.steps[stepNumber].prompts || [];
      return prompts[promptIndex]?.response || '';
    },

    setAnswer(stepNumber, promptIndex, response) {
      if (!this.steps[stepNumber]) {
        this.steps[stepNumber] = { prompts: [] };
      }
      if (!this.steps[stepNumber].prompts) {
        this.steps[stepNumber].prompts = [];
      }
      this.steps[stepNumber].prompts[promptIndex] = {
        response,
        completedAt: new Date().toISOString()
      };
      this.save();
    },

    isStepComplete(stepNumber) {
      const stepData = this.steps[stepNumber];
      if (!stepData) return false;
      const stepConfig = ps101Steps.find(s => s.step === stepNumber);
      if (!stepConfig) return false;
      const prompts = stepData.prompts || [];
      return prompts.length >= stepConfig.prompts.length && prompts.every(p => p && p.response && p.response.trim().length > 0);
    },

    getStepAnswers(stepNumber) {
      return this.steps[stepNumber] || { prompts: [] };
    },

    createExperiment() {
      const exp = {
        id: Date.now().toString(),
        createdAt: new Date().toISOString(),
        hypothesis: '',
        successMetric: '',
        startDate: '',
        reviewDate: '',
        resources: '',
        obstacles: [],
        actions: [],
        reflection: {
          outcome: '',
          learning: '',
          confidenceAfter: 5,
          nextMove: 'Continue'
        },
        status: 'active'
      };
      this.experiments.push(exp);
      this.save();
      return exp;
    },

    getActiveExperiment() {
      return this.experiments.find(e => e.status === 'active') || null;
    },

    updateExperiment(id, updates) {
      const exp = this.experiments.find(e => e.id === id);
      if (exp) {
        Object.assign(exp, updates);
        this.save();
      }
    }
  };

  PS101State.init();

  // Expose globally for debugging
  window.PS101State = PS101State;

  // UI Rendering Functions
  function renderPS101Flow() {
    const stepConfig = ps101Steps.find(s => s.step === PS101State.currentStep);
    if (!stepConfig) return;

    const questionText = $('#question-text');
    const stepAnswer = $('#step-answer');
    const stepLabel = $('#step-label');
    const backBtn = $('#ps101-back');
    const nextBtn = $('#ps101-next');
    const charCurrent = $('#char-current');
    const charMax = $('#char-max');
    const previousAnswers = $('#previous-answers');
    const experimentComponents = $('#experiment-components');

    if (stepLabel) {
      stepLabel.textContent = `Step ${stepConfig.step} of 10: ${stepConfig.title}`;
    }

    // Multi-prompt handling
    const currentStep = PS101State.currentStep;
    const promptIndex = PS101State.currentPromptIndex;
    const currentPrompt = stepConfig.prompts[promptIndex];

    if (questionText) {
      questionText.textContent = currentPrompt || '';
    }

    // Load existing answer for this prompt
    const isStepComplete = PS101State.isStepComplete(currentStep);
    const currentAnswer = PS101State.getAnswer(currentStep, promptIndex);
    if (stepAnswer) {
      stepAnswer.value = currentAnswer || '';
      updateCharCount();
    }

    // Show experiment components for steps 6-9
    if (experimentComponents) {
      if ([6, 7, 8, 9].includes(currentStep)) {
        experimentComponents.classList.remove('hidden');
        let activeExp = PS101State.getActiveExperiment();
        if (!activeExp && currentStep === 6) {
          activeExp = PS101State.createExperiment();
        }
        if (activeExp) {
          if (currentStep === 6) renderExperimentCanvas(activeExp);
          if (currentStep === 7) renderObstacleMapping(activeExp);
          if (currentStep === 8) renderActionPlan(activeExp);
          if (currentStep === 9) renderReflectionLog(activeExp);
        }
      } else {
        experimentComponents.classList.add('hidden');
      }
    }

    // Back/Next buttons
    if (backBtn) {
      backBtn.disabled = (currentStep === 1 && promptIndex === 0);
    }

    if (nextBtn) {
      const allPromptsAnswered = stepConfig.prompts.every((_, idx) => {
        return PS101State.getAnswer(currentStep, idx).trim().length >= (stepConfig.minChars || 10);
      });
      nextBtn.disabled = !allPromptsAnswered;
      if (currentStep === 10) {
        nextBtn.textContent = 'Complete PS101';
      } else {
        nextBtn.textContent = 'Next ‚Üí';
      }
    }

    // Update progress dots
    updateProgressDots();

    // Update previous answers section
    if (previousAnswers) {
      const completedSteps = Object.keys(PS101State.steps).filter(s => PS101State.isStepComplete(parseInt(s)));
      if (completedSteps.length > 0) {
        previousAnswers.classList.remove('hidden');
        const summaryText = previousAnswers.querySelector('.summary-text');
        if (summaryText) {
          summaryText.textContent = `‚ñº Previous Answers (${completedSteps.length} steps completed)`;
        }
        renderPreviousAnswers();
      } else {
        previousAnswers.classList.add('hidden');
      }
    }
  }

  function updateProgressDots() {
    const dots = document.querySelectorAll('.progress-dots .dot');
    dots.forEach((dot, index) => {
      const stepNumber = index + 1;
      dot.classList.remove('active', 'completed');
      if (stepNumber === PS101State.currentStep) {
        dot.classList.add('active');
      } else if (PS101State.isStepComplete(stepNumber)) {
        dot.classList.add('completed');
      }
      dot.disabled = stepNumber > PS101State.currentStep && !PS101State.isStepComplete(stepNumber - 1);
    });
  }

  function renderPreviousAnswers() {
    const answerList = document.querySelector('.answer-list');
    if (!answerList) return;
    answerList.innerHTML = '';
    const completedSteps = Object.keys(PS101State.steps).filter(s => PS101State.isStepComplete(parseInt(s))).map(Number).sort((a, b) => a - b);
    completedSteps.forEach(stepNum => {
      const stepConfig = ps101Steps.find(s => s.step === stepNum);
      const stepAnswers = PS101State.getStepAnswers(stepNum);
      if (!stepConfig || !stepAnswers.prompts) return;
      stepAnswers.prompts.forEach((promptData, idx) => {
        const card = document.createElement('div');
        card.className = 'answer-card';
        card.innerHTML = `
          <div class="answer-header">
            <span class="answer-step">Step ${stepNum}: ${stepConfig.title} (Q${idx + 1})</span>
            <button class="answer-edit" data-step="${stepNum}" data-prompt="${idx}">Edit</button>
          </div>
          <div class="answer-content">${promptData.response || ''}</div>
        `;
        answerList.appendChild(card);
      });
    });
    // Add edit listeners
    answerList.querySelectorAll('.answer-edit').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const step = parseInt(btn.dataset.step);
        const prompt = parseInt(btn.dataset.prompt);
        PS101State.currentStep = step;
        PS101State.currentPromptIndex = prompt;
        PS101State.save();
        renderPS101Flow();
      });
    });
  }

  function updateCharCount() {
    const stepAnswer = $('#step-answer');
    const charCurrent = $('#char-current');
    if (stepAnswer && charCurrent) {
      charCurrent.textContent = stepAnswer.value.length;
    }
  }

  function renderExperimentCanvas(experiment) {
    const canvas = $('#experiment-canvas');
    if (!canvas) return;
    canvas.classList.remove('hidden');
    $('#exp-hypothesis').value = experiment.hypothesis || '';
    $('#exp-success-metric').value = experiment.successMetric || '';
    $('#exp-start-date').value = experiment.startDate || '';
    $('#exp-review-date').value = experiment.reviewDate || '';
    $('#exp-resources').value = experiment.resources || '';
  }

  function renderObstacleMapping(experiment) {
    const mapping = $('#obstacle-mapping');
    if (!mapping) return;
    mapping.classList.remove('hidden');
    const obstaclesList = $('#obstacles-list');
    if (!obstaclesList) return;
    obstaclesList.innerHTML = '';
    (experiment.obstacles || []).forEach(obstacle => {
      const item = document.createElement('div');
      item.className = 'obstacle-item';
      item.innerHTML = `
        <div class="obstacle-header">
          <span>${obstacle.label}</span>
          <button class="btn-remove" data-id="${obstacle.id}">√ó</button>
        </div>
        <span class="obstacle-type ${obstacle.type}">${obstacle.type}</span>
        <div class="obstacle-strategy">${obstacle.strategy}</div>
      `;
      obstaclesList.appendChild(item);
    });
    obstaclesList.querySelectorAll('.btn-remove').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        experiment.obstacles = experiment.obstacles.filter(o => o.id !== id);
        PS101State.updateExperiment(experiment.id, { obstacles: experiment.obstacles });
        renderObstacleMapping(experiment);
      });
    });
  }

  function renderActionPlan(experiment) {
    const plan = $('#action-plan');
    if (!plan) return;
    plan.classList.remove('hidden');
    const actionsList = $('#actions-list');
    if (!actionsList) return;
    actionsList.innerHTML = '';
    (experiment.actions || []).forEach(action => {
      const item = document.createElement('div');
      item.className = 'action-item';
      item.innerHTML = `
        <div class="action-header">
          <div class="action-checkbox">
            <input type="checkbox" ${action.completed ? 'checked' : ''} data-id="${action.id}">
            <span>${action.label}</span>
          </div>
          <button class="btn-remove" data-id="${action.id}">√ó</button>
        </div>
        ${action.dueDate ? `<div class="action-due">Due: ${action.dueDate}</div>` : ''}
        ${action.accountability ? `<div class="action-due">Accountable: ${action.accountability}</div>` : ''}
      `;
      actionsList.appendChild(item);
    });
    actionsList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const id = checkbox.dataset.id;
        const action = experiment.actions.find(a => a.id === id);
        if (action) {
          action.completed = checkbox.checked;
          PS101State.updateExperiment(experiment.id, { actions: experiment.actions });
        }
      });
    });
    actionsList.querySelectorAll('.btn-remove').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        experiment.actions = experiment.actions.filter(a => a.id !== id);
        PS101State.updateExperiment(experiment.id, { actions: experiment.actions });
        renderActionPlan(experiment);
      });
    });
  }

  function renderReflectionLog(experiment) {
    const log = $('#reflection-log');
    if (!log) return;
    log.classList.remove('hidden');
    $('#reflection-outcome').value = experiment.reflection?.outcome || '';
    $('#reflection-learning').value = experiment.reflection?.learning || '';
    $('#reflection-confidence').value = experiment.reflection?.confidenceAfter || 5;
    $('#confidence-value').textContent = experiment.reflection?.confidenceAfter || 5;
    $('#reflection-next-move').value = experiment.reflection?.nextMove || 'Continue';
  }

  // Event Listeners for PS101 Flow
  const startPS101Btn = $('#start-ps101');
  if (startPS101Btn) {
    startPS101Btn.addEventListener('click', () => {
      PS101State.reset();
      $('#ps101-welcome').classList.add('hidden');
      $('#ps101-flow').classList.remove('hidden');
      renderPS101Flow();
    });
  }

  const continuePS101Btn = $('#continue-ps101');
  if (continuePS101Btn) {
    continuePS101Btn.addEventListener('click', () => {
      $('#ps101-welcome').classList.add('hidden');
      $('#ps101-flow').classList.remove('hidden');
      renderPS101Flow();
    });
  }

  const backBtn = $('#ps101-back');
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      const state = PS101State;
      if (state.currentPromptIndex > 0) {
        state.currentPromptIndex--;
      } else if (state.currentStep > 1) {
        state.currentStep--;
        const prevStepConfig = ps101Steps.find(s => s.step === state.currentStep);
        state.currentPromptIndex = prevStepConfig ? prevStepConfig.prompts.length - 1 : 0;
      }
      state.save();
      renderPS101Flow();
    });
  }

  const nextBtn = $('#ps101-next');
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      const state = PS101State;
      const currentStep = state.currentStep;
      const promptIndex = state.currentPromptIndex;
      const stepConfig = ps101Steps.find(s => s.step === currentStep);

      // Save current answer
      const stepAnswer = $('#step-answer');
      if (stepAnswer) {
        const answerText = stepAnswer.value.trim();
        if (answerText.length >= (stepConfig?.minChars || 10)) {
          PS101State.setAnswer(currentStep, promptIndex, answerText);
        }
      }

      // Save experiment data for steps 6-9
      if (currentStep === 6) {
        const activeExp = PS101State.getActiveExperiment();
        if (activeExp) {
          activeExp.hypothesis = $('#exp-hypothesis')?.value || '';
          activeExp.successMetric = $('#exp-success-metric')?.value || '';
          activeExp.startDate = $('#exp-start-date')?.value || '';
          activeExp.reviewDate = $('#exp-review-date')?.value || '';
          activeExp.resources = $('#exp-resources')?.value || '';
          PS101State.updateExperiment(activeExp.id, activeExp);
        }
      }

      if (currentStep === 9) {
        const activeExp = PS101State.getActiveExperiment();
        if (activeExp) {
          activeExp.reflection = {
            outcome: $('#reflection-outcome')?.value || '',
            learning: $('#reflection-learning')?.value || '',
            confidenceAfter: parseInt($('#reflection-confidence')?.value || '5'),
            nextMove: $('#reflection-next-move')?.value || 'Continue'
          };
          activeExp.status = 'completed';
          PS101State.updateExperiment(activeExp.id, activeExp);
        }
      }

      // Move to next prompt or step
      if (promptIndex < stepConfig.prompts.length - 1) {
        state.currentPromptIndex++;
        state.save();
        renderPS101Flow();
      } else if (currentStep < 10) {
        state.currentStep++;
        state.currentPromptIndex = 0;
        state.save();
        renderPS101Flow();
      } else {
        // Complete
        state.completed = true;
        state.save();
        showPS101Completion();
      }
    });
  }

  function showPS101Completion() {
    $('#ps101-flow').classList.add('hidden');
    $('#ps101-completion').classList.remove('hidden');

    const commitmentText = $('#commitment-text');
    const step7Answer = PS101State.getAnswer(7, 0);
    if (commitmentText) {
      commitmentText.textContent = step7Answer || 'No commitment recorded';
    }
  }

  const stepAnswer = $('#step-answer');
  if (stepAnswer) {
    stepAnswer.addEventListener('input', updateCharCount);
  }

  // Confidence slider
  const reflectionConfidence = $('#reflection-confidence');
  if (reflectionConfidence) {
    reflectionConfidence.addEventListener('input', (e) => {
      const confidenceValue = $('#confidence-value');
      if (confidenceValue) {
        confidenceValue.textContent = e.target.value;
      }
    });
  }

  // Obstacle form handlers
  const addObstacleBtn = $('#add-obstacle-btn');
  const obstacleForm = $('#add-obstacle-form');
  const saveObstacleBtn = $('#save-obstacle-btn');
  const cancelObstacleBtn = $('#cancel-obstacle-btn');

  if (addObstacleBtn && obstacleForm) {
    addObstacleBtn.addEventListener('click', () => {
      obstacleForm.classList.remove('hidden');
    });
  }

  if (cancelObstacleBtn && obstacleForm) {
    cancelObstacleBtn.addEventListener('click', () => {
      obstacleForm.classList.add('hidden');
      $('#obstacle-label').value = '';
      $('#obstacle-strategy').value = '';
    });
  }

  if (saveObstacleBtn) {
    saveObstacleBtn.addEventListener('click', () => {
      const label = $('#obstacle-label')?.value.trim();
      const strategy = $('#obstacle-strategy')?.value.trim();
      const type = document.querySelector('input[name="obstacle-type"]:checked')?.value || 'external';

      if (!label || !strategy) return;

      const activeExp = PS101State.getActiveExperiment();
      if (activeExp) {
        if (!activeExp.obstacles) activeExp.obstacles = [];
        activeExp.obstacles.push({
          id: Date.now().toString(),
          label,
          type,
          strategy
        });
        PS101State.updateExperiment(activeExp.id, activeExp);
        renderObstacleMapping(activeExp);
        obstacleForm.classList.add('hidden');
        $('#obstacle-label').value = '';
        $('#obstacle-strategy').value = '';
      }
    });
  }

  // Action form handlers
  const addActionBtn = $('#add-action-btn');
  const actionForm = $('#add-action-form');
  const saveActionBtn = $('#save-action-btn');
  const cancelActionBtn = $('#cancel-action-btn');

  if (addActionBtn && actionForm) {
    addActionBtn.addEventListener('click', () => {
      actionForm.classList.remove('hidden');
    });
  }

  if (cancelActionBtn && actionForm) {
    cancelActionBtn.addEventListener('click', () => {
      actionForm.classList.add('hidden');
      $('#action-label').value = '';
      $('#action-due').value = '';
      $('#action-accountability').value = '';
    });
  }

  if (saveActionBtn) {
    saveActionBtn.addEventListener('click', () => {
      const label = $('#action-label')?.value.trim();
      const dueDate = $('#action-due')?.value.trim();
      const accountability = $('#action-accountability')?.value.trim();

      if (!label) return;

      const activeExp = PS101State.getActiveExperiment();
      if (activeExp) {
        if (!activeExp.actions) activeExp.actions = [];
        activeExp.actions.push({
          id: Date.now().toString(),
          label,
          dueDate,
          accountability,
          completed: false
        });
        PS101State.updateExperiment(activeExp.id, activeExp);
        renderActionPlan(activeExp);
        actionForm.classList.add('hidden');
        $('#action-label').value = '';
        $('#action-due').value = '';
        $('#action-accountability').value = '';
      }
    });
  }

  // Progress dot navigation
  document.querySelectorAll('.progress-dots .dot').forEach(dot => {
    dot.addEventListener('click', () => {
      const stepNumber = parseInt(dot.dataset.step);
      if (!dot.disabled && stepNumber <= PS101State.currentStep) {
        PS101State.goToStep(stepNumber);
        renderPS101Flow();
      }
    });
  });

  // Check if user has saved progress on page load
  if (window.PS101State && window.PS101State.steps && Object.keys(window.PS101State.steps).length > 0 && !window.PS101State.completed) {
    const welcomeResume = $('#welcome-resume');
    if (welcomeResume) {
      welcomeResume.classList.remove('hidden');
    }
  }


})();
</script>
</body>
</html>
