<!doctype html>
<meta charset="utf-8">
<title>Mosaic Platform — Values-First Career Development</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--fg:#000;--muted:#666;--line:#e8e8e8;--hair:#111;--max:980px;--api:'https://mosaic-platform.vercel.app'}
  *{box-sizing:border-box}
  html,body{margin:0;background:#fff;color:var(--fg)}
  body{font:12px/1.75 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  a:hover,a:focus{text-decoration:underline}
  .wrap{max-width:var(--max);margin:0 auto;padding:28px 20px}

  .nav{display:flex;gap:24px;margin-bottom:60px;align-items:center}
  .hero{margin:120px 0 40px}
  .title{font:500 15px/1.4 Helvetica,Arial;letter-spacing:.02em}
  .sub{color:var(--muted);max-width:64ch}
  .actions{margin:24px 0 0;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .quiet{border:1px solid var(--line);padding:6px 10px;background:#fff;cursor:pointer}
  .quiet:hover{background:#f8f8f8}

  svg.schema{display:block;width:100%;height:auto;margin:50px 0}
  .wire{stroke:var(--hair);stroke-width:.7;fill:none;stroke-linecap:round;stroke-linejoin:round}
  .dot{fill:var(--hair)}

  .rule{border-top:1px solid var(--line);margin:80px 0}
  .metrics{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;margin:30px 0 90px}
  .card{border:1px solid var(--line);padding:14px}
  .k{color:var(--muted);text-transform:uppercase;letter-spacing:.08em;font-size:10px}
  .v{font-size:18px;font-weight:600;margin-top:4px}

  .island{margin:100px 0}
  .module{margin:70px 0}
  .module h3{margin:0 0 6px;font:600 12px/1 Helvetica,Arial;text-transform:uppercase;letter-spacing:.06em}
  .module ul{list-style:none;margin:6px 0 0;padding:0;color:var(--muted)}
  .module li{margin:3px 0}
  textarea.small{width:100%;min-height:60px;border:1px solid var(--line);padding:8px;background:#fff;font:inherit}
  .module-actions{margin-top:8px;display:flex;gap:12px;flex-wrap:wrap}
  .module-actions a{color:var(--muted);font-size:11px}

  .welcome-title{font:600 12px/1 Helvetica,Arial;text-transform:uppercase;letter-spacing:.08em}
  details.micro{margin-top:16px}
  details.micro summary{cursor:pointer}

  .chat{position:fixed;right:20px;bottom:20px;width:320px;max-width:90vw;background:#fff;border:1px solid var(--line);box-shadow:0 8px 30px rgba(0,0,0,.06);display:none;z-index:1000}
  .chat header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line)}
  .chat header .x{border:1px solid var(--line);padding:2px 6px;background:#fff;cursor:pointer}
  .chat main{padding:10px 12px;height:220px;overflow:auto}
  .msg{margin:6px 0;font:11px/1.4 Helvetica,Arial}
  .msg.you{color:var(--hair)}
  .msg.bot{color:var(--muted)}
  .msg.loading{color:var(--muted);opacity:0.6}
  .chat footer{padding:8px 10px;border-top:1px solid var(--line);display:flex;gap:6px}
  .chat input{flex:1;border:1px solid var(--line);padding:6px 8px;font:inherit}
  .chat button{border:1px solid var(--line);padding:6px 8px;background:#fff;cursor:pointer}

  .modal{position:fixed;inset:0;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal .panel{background:#fff;border:1px solid var(--line);padding:20px;min-width:280px;max-width:92vw}
  .modal .close{margin-top:16px;border:1px solid var(--line);background:#fff;padding:6px 10px;cursor:pointer}
  .drop{border:1px dashed #ccc;padding:24px;text-align:center;cursor:pointer}
  .drop:hover{background:#fafafa}

  .coach-strip{margin:24px 0 60px;border:1px solid var(--line);padding:6px 8px;display:flex;gap:8px;align-items:center}
  .coach-strip input{flex:1;border:1px solid var(--line);padding:6px 8px;font:inherit}
  .coach-strip span{color:var(--muted);font:11px/1 Helvetica,Arial}

  .savebar{margin:80px 0 0;display:flex;gap:18px;flex-wrap:wrap}
  .btn{border:1px solid var(--line);padding:6px 10px;background:#fff;cursor:pointer;font:inherit}
  .btn:hover{background:#f8f8f8}

  .formrow{margin:16px 0}
  .radio{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .radio label{display:flex;gap:6px;align-items:center;cursor:pointer}
  .rating{display:flex;gap:8px;align-items:center;margin-top:8px}
  .rating button{border:1px solid var(--line);padding:4px 8px;background:#fff;cursor:pointer;font:11px/1 Helvetica,Arial}
  .rating button.selected{background:#f0f0f0;border-color:var(--hair)}
  .rating button:hover{background:#f8f8f8}
  .notice{position:fixed;left:20px;right:20px;bottom:16px;display:none;justify-content:space-between;gap:12px;background:#fff;border:1px solid var(--line);padding:8px 10px;z-index:1500}
  .notice .btn{border:1px solid var(--line);background:#fff;padding:6px 10px}

  .foot{border-top:1px solid var(--line);margin-top:140px;padding:14px 0;color:#777;font-size:12px;display:flex;justify-content:space-between}
  
  .status{display:inline-block;padding:2px 6px;font-size:10px;border-radius:2px}
  .status.working{background:#e8f5e8;color:#2d6e2d}
  .status.error{background:#ffe8e8;color:#d63638}
  
  @media (max-width:860px){
    .metrics{grid-template-columns:1fr}
    .actions{flex-direction:column;align-items:flex-start}
    .radio{flex-direction:column;align-items:flex-start}
    .rating{flex-wrap:wrap}
  }
</style>

<div class="wrap">
  <nav class="nav">
    <a href="#modules" title="Modules">modules</a>
    <a href="#learn" title="Learn">learn</a>
    <a id="openUpload" href="#" title="Upload a resume, image, or audio">upload</a>
    <a id="openChat" href="#" title="Open coaching chat">chat</a>
    <span class="status working" id="apiStatus">api ready</span>
  </nav>

  <!-- COACH STRIP -->
  <div class="coach-strip">
    <span>coach</span>
    <input id="coachAsk" placeholder="ask or try: fast track" autocomplete="off">
    <button id="coachSend" class="quiet">send</button>
  </div>

  <!-- WELCOME / INTRO -->
  <section id="welcome" class="island" aria-label="Welcome">
    <div class="welcome-title" title="values-first career platform">mosaic platform</div>
    <p class="sub" title="what this is">values‑first workspace combining WIMD and OpportunityBridge. pick a path or ask the coach.</p>
    <div class="actions">
      <button class="quiet" id="linkFast" title="guided route: ps101 → coaching → dashboard">fast track</button>
      <button class="quiet" id="linkDiscover" title="wander through modules and notes">discovery</button>
      <button class="quiet" id="showJourney" title="show the full journey on this page">intro</button>
      <button class="quiet" id="saveBtn" title="Save progress to file">save</button>
      <label class="quiet" for="loadFile" title="Load a saved file">load<input id="loadFile" type="file" accept="application/json" hidden></label>
    </div>
    <details class="micro"><summary>what's the difference?</summary>
      <small>fast track gives you a direct sequence (ps101 → coaching → dashboard). discovery lets you skim modules, read notes, and dip in where you like.</small>
    </details>
  </section>

  <header class="hero" id="top">
    <div class="title">WIMD + OPPORTUNITYBRIDGE</div>
    <p class="sub">values‑first career platform. clear metrics. focused coaching. no clutter.</p>
  </header>

  <svg class="schema" viewBox="0 0 980 140" aria-hidden="true">
    <path class="wire" d="M120 90 H360 C400 90 420 78 450 70 C480 62 520 60 560 68 C600 76 640 60 700 58 C820 54 860 54 900 56"/>
    <circle class="dot" cx="120" cy="90" r="1.2"/>
  </svg>

  <div class="rule"></div>

  <section class="metrics" aria-label="Metrics">
    <div class="card"><div class="k">Clarity</div><div class="v" id="mClarity">75%</div></div>
    <div class="card"><div class="k">Action</div><div class="v" id="mAction">45%</div></div>
    <div class="card"><div class="k">Momentum</div><div class="v" id="mMomentum">32%</div></div>
  </section>

  <section id="modules" class="island" aria-label="Modules">
    <div class="module" id="ps101">
      <h3><a href="#ps101" title="open PS101">PS101 — Foundations</a></h3>
      <ul><li>Values inventory</li><li>Narrative capture</li><li>Signal extraction</li></ul>
      <textarea class="small" placeholder="your values / narrative / signals…" id="t_ps101"></textarea>
      <div class="module-actions">
        <a href="#" data-coach="help me start ps101 with 3 values">ask coach: start ps101</a>
      </div>
    </div>
    
    <div class="module" id="coaching">
      <h3><a href="#coaching" title="open Coaching">Coaching — Sprint</a></h3>
      <ul><li>Weekly check‑ins</li><li>Action ledger</li><li>Friction mapping</li></ul>
      <textarea class="small" placeholder="today's focus / shipped / blocked…" id="t_coaching"></textarea>
      <div class="module-actions">
        <a href="#" data-coach="help me set today's focus and 1 action">ask coach: focus</a>
      </div>
    </div>
    
    <div class="module" id="jobs">
      <h3><a href="#jobs" title="open Jobs">Jobs — Fit Scan</a></h3>
      <ul><li>Role triage</li><li>Keyword heatmap</li><li>Risk notes</li></ul>
      <textarea class="small" placeholder="roles / keywords / risks…" id="t_jobs"></textarea>
      <div class="module-actions">
        <a href="#" data-coach="help me triage 3 roles">ask coach: triage roles</a>
        <a href="#" id="findJobs" title="Find values-aligned jobs">find opportunities</a>
      </div>
    </div>
    
    <div class="module" id="resume">
      <h3><a href="#resume" title="open Resume">Resume — Bridge</a></h3>
      <ul><li>Evidence mapping</li><li>ATS lines</li><li>Truth filters</li></ul>
      <textarea class="small" placeholder="evidence → concise ATS lines…" id="t_resume"></textarea>
      <div class="module-actions">
        <a href="#" data-coach="turn this evidence into one ats line">ask coach: ats line</a>
      </div>
    </div>
    
    <div class="module" id="dashboard">
      <h3><a href="#dashboard" title="open Dashboard">Delta — Dashboard</a></h3>
      <ul><li>Clarity graph</li><li>Action trend</li><li>Next steps</li></ul>
      <textarea class="small" placeholder="next step (one thing to do)…" id="t_dashboard"></textarea>
      <div class="module-actions">
        <a href="#" data-coach="suggest 1 next step from my notes">ask coach: next step</a>
      </div>
    </div>
  </section>

  <div class="rule"></div>

  <section id="learn" class="island" aria-label="Learn">
    <div style="margin:6px 0"><a href="#learn" title="principles">principles</a></div>
    <div style="margin:24px 0"><a href="#learn" title="getting started">getting started</a></div>
    <div style="margin:24px 0"><a href="#learn" title="coaching flow">coaching flow</a></div>
    <div style="margin:24px 0"><a href="#learn" title="jobs & fit">jobs & fit</a></div>
  </section>

  <!-- EMBEDDED FEEDBACK SYSTEM -->
  <section id="feedback" class="island" aria-label="Beta Feedback">
    <div class="welcome-title" title="help us improve">beta feedback</div>
    <p class="sub">quick feedback to improve this platform. captured locally and exportable.</p>

    <div class="formrow">
      <div class="k">how helpful was this session?</div>
      <div class="rating" id="helpfulnessRating">
        <button data-rating="1">1</button>
        <button data-rating="2">2</button>
        <button data-rating="3">3</button>
        <button data-rating="4">4</button>
        <button data-rating="5">5</button>
      </div>
    </div>

    <div class="formrow">
      <div class="k">what worked well?</div>
      <textarea id="fb_worked_well" class="small" placeholder="what resonated or felt helpful…"></textarea>
    </div>

    <div class="formrow">
      <div class="k">what could be improved?</div>
      <textarea id="fb_improve" class="small" placeholder="what felt unclear or could be better…"></textarea>
    </div>

    <div class="formrow">
      <div class="k">preferred experience</div>
      <div class="radio">
        <label><input type="radio" name="fb_experience" value="fast track"> fast track</label>
        <label><input type="radio" name="fb_experience" value="discovery"> discovery</label>
        <label><input type="radio" name="fb_experience" value="mixed approach"> mixed approach</label>
      </div>
    </div>

    <div class="actions" style="margin-top:20px">
      <button id="fbCapture" class="quiet" title="Save feedback locally">capture feedback</button>
      <button id="fbExport" class="quiet" title="Download feedback as JSON file">export feedback</button>
      <span id="fbStatus" style="color:var(--muted);font-size:11px;display:none"></span>
    </div>
  </section>

  <div class="notice" id="saveNotice" aria-live="polite">
    <div>save before you leave?</div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="noticeSave">save now</button>
      <button class="btn" id="noticeDismiss">dismiss</button>
    </div>
  </div>

  <footer class="foot">
    <div>© <span id="y"></span> Mosaic Platform</div>
    <div>values-first career coaching</div>
  </footer>
</div>

<!-- CHAT -->
<aside class="chat" id="chat">
  <header>
    <div>coaching</div>
    <button class="x" id="closeChat" title="Close">×</button>
  </header>
  <main id="chatLog" aria-live="polite"></main>
  <footer>
    <input id="chatInput" placeholder="type and enter…" aria-label="message" autocomplete="off">
    <button class="btn" id="sendMsg">send</button>
  </footer>
</aside>

<!-- UPLOAD MODAL -->
<div class="modal" id="uploadModal">
  <div class="panel">
    <div class="drop" id="dropZone">
      <div style="margin-bottom:10px">upload a resume, image, or audio</div>
      <input type="file" id="filePick" multiple accept=".pdf,.docx,.txt,.mp3,.wav,.m4a,.jpg,.jpeg,.png">
      <div style="margin-top:8px;font-size:11px;color:var(--muted)">drag files here or click to select</div>
    </div>
    <div id="uploadStatus" style="margin-top:12px;display:none">
      <div style="font-size:11px;color:var(--muted)">uploading...</div>
    </div>
    <button class="close" id="closeUpload">close</button>
  </div>
</div>

<script>
(function(){
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const API_BASE = 'https://mosaic-platform.vercel.app';

  $('#y').textContent = new Date().getFullYear();

  // API Status Check
  async function checkAPI() {
    try {
      const response = await fetch(`${API_BASE}/health`);
      if (response.ok) {
        $('#apiStatus').textContent = 'api ready';
        $('#apiStatus').className = 'status working';
      }
    } catch (error) {
      $('#apiStatus').textContent = 'api offline';
      $('#apiStatus').className = 'status error';
    }
  }
  checkAPI();

  // Chat System with Real API Integration
  const chat = $('#chat');
  const chatLog = $('#chatLog');
  const chatInput = $('#chatInput');
  const sendMsg = $('#sendMsg');

  $('#openChat').addEventListener('click', e => {
    e.preventDefault(); 
    chat.style.display = 'block';
  });
  
  $('#closeChat').addEventListener('click', () => {
    chat.style.display = 'none'
  });

  function addMsg(txt, who = 'you') {
    const div = document.createElement('div');
    div.className = `msg ${who}`;
    div.textContent = (who === 'you' ? '> ' : '') + txt;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  async function askCoach(message) {
    try {
      const response = await fetch(`${API_BASE}/wimd`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      return data?.result?.message || data?.message || data?.result || 'no response from coach';
    } catch (error) {
      console.error('Coach API error:', error);
      return `connection issue (${error.message})`;
    }
  }

  async function send() {
    const v = chatInput.value.trim();
    if (!v) return;
    
    addMsg(v, 'you');
    chatInput.value = '';
    
    // Show loading
    addMsg('thinking...', 'loading');
    
    try {
      const response = await askCoach(v);
      // Remove loading message
      const loadingMsg = chatLog.querySelector('.msg.loading:last-child');
      if (loadingMsg) loadingMsg.remove();
      
      addMsg(response, 'bot');
    } catch (error) {
      // Remove loading message
      const loadingMsg = chatLog.querySelector('.msg.loading:last-child');
      if (loadingMsg) loadingMsg.remove();
      
      addMsg('connection issue', 'bot');
    }
    
    softRoute(v);
  }

  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      send();
    }
  });
  
  sendMsg.addEventListener('click', send);

  // Coach Strip (immediate input)
  const coachAsk = $('#coachAsk');
  const coachSend = $('#coachSend');

  function sendStrip() {
    const v = (coachAsk.value || '').trim();
    if (!v) return;
    
    chat.style.display = 'block';
    addMsg(v, 'you');
    coachAsk.value = '';
    
    // Show loading
    addMsg('thinking...', 'loading');
    
    askCoach(v).then(response => {
      // Remove loading message
      const loadingMsg = chatLog.querySelector('.msg.loading:last-child');
      if (loadingMsg) loadingMsg.remove();
      
      addMsg(response, 'bot');
    }).catch(error => {
      // Remove loading message  
      const loadingMsg = chatLog.querySelector('.msg.loading:last-child');
      if (loadingMsg) loadingMsg.remove();
      
      addMsg('connection issue', 'bot');
    });
    
    softRoute(v);
  }

  coachSend.addEventListener('click', sendStrip);
  coachAsk.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendStrip();
    }
  });

  // First-visit gentle nudge (auto-open coach once)
  const SEEN = 'mosaic_seen_intro_v1';
  if (!localStorage.getItem(SEEN)) {
    setTimeout(() => {
      chat.style.display = 'block';
      addMsg('hi — prefer fast track or discovery?', 'bot');
      localStorage.setItem(SEEN, '1');
    }, 1000);
  }

  // Upload with Real API Integration
  const modal = $('#uploadModal');
  const dropZone = $('#dropZone');
  const filePick = $('#filePick');
  const uploadStatus = $('#uploadStatus');

  $('#openUpload').addEventListener('click', e => {
    e.preventDefault();
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  });

  $('#closeUpload').addEventListener('click', () => {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  });

  // File upload functionality
  async function uploadFile(file) {
    try {
      uploadStatus.style.display = 'block';
      uploadStatus.innerHTML = '<div style="font-size:11px;color:var(--muted)">uploading ' + file.name + '...</div>';

      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch(`${API_BASE}/wimd/upload`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const result = await response.json();
      
      uploadStatus.innerHTML = '<div style="font-size:11px;color:#2d6e2d">upload complete!</div>';
      
      // Add result to chat
      chat.style.display = 'block';
      addMsg(`uploaded: ${file.name}`, 'you');
      addMsg(result?.result?.message || result?.result || 'file processed', 'bot');
      
      // Close modal after short delay
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        uploadStatus.style.display = 'none';
      }, 2000);

    } catch (error) {
      uploadStatus.innerHTML = '<div style="font-size:11px;color:#d63638">upload failed: ' + error.message + '</div>';
      console.error('Upload error:', error);
    }
  }

  filePick.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;
    
    for (let file of files) {
      await uploadFile(file);
    }
  });

  // Drag and drop
  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.style.background = '#f8f8f8';
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.style.background = '';
  });

  dropZone.addEventListener('drop', async (e) => {
    e.preventDefault();
    dropZone.style.background = '';
    
    const files = e.dataTransfer.files;
    for (let file of files) {
      await uploadFile(file);
    }
  });

  // Job Search Integration
  $('#findJobs').addEventListener('click', async (e) => {
    e.preventDefault();
    
    const jobsText = $('#t_jobs').value.trim();
    const query = jobsText || 'career opportunities';
    
    chat.style.display = 'block';
    addMsg(`finding jobs: ${query}`, 'you');
    addMsg('searching...', 'loading');
    
    try {
      const response = await fetch(`${API_BASE}/jobsearch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          query: query
        })
      });

      const loadingMsg = chatLog.querySelector('.msg.loading:last-child');
      if (loadingMsg) loadingMsg.remove();

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const result = await response.json();
      const jobsFound = result?.results?.length || 0;
      addMsg(`found ${jobsFound} opportunities. check your dashboard module for details.`, 'bot');
      
    } catch (error) {
      const loadingMsg = chatLog.querySelector('.msg.loading:last-child');
      if (loadingMsg) loadingMsg.remove();
      
      addMsg('job search temporarily unavailable', 'bot');
      console.error('Job search error:', error);
    }
  });

  // Embedded Feedback System
  let helpfulnessScore = 0;
  const helpfulnessRating = $('#helpfulnessRating');
  const fbStatus = $('#fbStatus');

  // Rating buttons
  helpfulnessRating.addEventListener('click', (e) => {
    if (e.target.hasAttribute('data-rating')) {
      // Remove selected from all buttons
      helpfulnessRating.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
      // Add selected to clicked button
      e.target.classList.add('selected');
      helpfulnessScore = parseInt(e.target.getAttribute('data-rating'));
      markFeedbackDirty();
    }
  });

  function collectBetaFeedback() {
    const experienceEl = document.querySelector('input[name="fb_experience"]:checked');
    return {
      timestamp: new Date().toISOString(),
      helpfulness: helpfulnessScore,
      workedWell: $('#fb_worked_well').value.trim(),
      couldImprove: $('#fb_improve').value.trim(),
      preferredExperience: experienceEl ? experienceEl.value : '',
      sessionData: collectSessionData()
    };
  }

  function collectSessionData() {
    return {
      metrics: {
        clarity: $('#mClarity').textContent,
        action: $('#mAction').textContent,
        momentum: $('#mMomentum').textContent
      },
      notes: {
        ps101: $('#t_ps101').value,
        coaching: $('#t_coaching').value,
        jobs: $('#t_jobs').value,
        resume: $('#t_resume').value,
        dashboard: $('#t_dashboard').value
      }
    };
  }

  let feedbackDirty = false;
  function markFeedbackDirty() {
    feedbackDirty = true;
    saveFeedbackAuto();
  }

  const FEEDBACK_STORAGE = 'mosaic_beta_feedback_v1';
  function saveFeedbackAuto() {
    const feedback = collectBetaFeedback();
    localStorage.setItem(FEEDBACK_STORAGE, JSON.stringify(feedback));
  }

  function loadFeedbackAuto() {
    try {
      const stored = localStorage.getItem(FEEDBACK_STORAGE);
      if (stored) {
        const feedback = JSON.parse(stored);
        if (feedback.helpfulness) {
          helpfulnessScore = feedback.helpfulness;
          const ratingBtn = helpfulnessRating.querySelector(`[data-rating="${feedback.helpfulness}"]`);
          if (ratingBtn) ratingBtn.classList.add('selected');
        }
        if (feedback.workedWell) $('#fb_worked_well').value = feedback.workedWell;
        if (feedback.couldImprove) $('#fb_improve').value = feedback.couldImprove;
        if (feedback.preferredExperience) {
          const experienceEl = document.querySelector(`input[name="fb_experience"][value="${feedback.preferredExperience}"]`);
          if (experienceEl) experienceEl.checked = true;
        }
      }
    } catch (e) {
      console.error('Failed to load feedback:', e);
    }
  }

  // Feedback capture and export
  $('#fbCapture').addEventListener('click', () => {
    const feedback = collectBetaFeedback();
    localStorage.setItem(FEEDBACK_STORAGE, JSON.stringify(feedback));
    fbStatus.textContent = 'feedback captured locally';
    fbStatus.style.display = 'inline';
    setTimeout(() => fbStatus.style.display = 'none', 3000);
  });

  $('#fbExport').addEventListener('click', () => {
    const feedback = collectBetaFeedback();
    const blob = new Blob([JSON.stringify(feedback, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `mosaic-beta-feedback-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    fbStatus.textContent = 'feedback exported to download';
    fbStatus.style.display = 'inline';
    setTimeout(() => fbStatus.style.display = 'none', 3000);
  });

  // Track feedback form changes
  ['#fb_worked_well', '#fb_improve'].forEach(sel =>
    $(sel)?.addEventListener('input', markFeedbackDirty)
  );
  
  document.getElementsByName('fb_experience').forEach(el =>
    el.addEventListener('change', markFeedbackDirty)
  );

  // Auto-save every 30 seconds
  const AUTOSAVE_INTERVAL = 30000;
  let autoSaveTimer;

  function startAutoSave() {
    if (autoSaveTimer) clearInterval(autoSaveTimer);
    autoSaveTimer = setInterval(() => {
      saveAuto();
      if (feedbackDirty) saveFeedbackAuto();
    }, AUTOSAVE_INTERVAL);
  }

  // Save / Load + Leave Guard
  let dirty = false, savedThisSession = false;

  function markDirty() {
    dirty = true;
    $('#saveNotice').style.display = 'flex';
  }

  function collect() {
    return {
      timestamp: new Date().toISOString(),
      metrics: {
        clarity: $('#mClarity').textContent,
        action: $('#mAction').textContent,
        momentum: $('#mMomentum').textContent
      },
      notes: {
        ps101: $('#t_ps101').value,
        coaching: $('#t_coaching').value,
        jobs: $('#t_jobs').value,
        resume: $('#t_resume').value,
        dashboard: $('#t_dashboard').value
      },
      feedback: collectBetaFeedback()
    };
  }

  function apply(data) {
    if (data?.metrics) {
      $('#mClarity').textContent = data.metrics.clarity || '75%';
      $('#mAction').textContent = data.metrics.action || '45%';
      $('#mMomentum').textContent = data.metrics.momentum || '32%';
    }
    if (data?.notes) {
      $('#t_ps101').value = data.notes.ps101 || '';
      $('#t_coaching').value = data.notes.coaching || '';
      $('#t_jobs').value = data.notes.jobs || '';
      $('#t_resume').value = data.notes.resume || '';
      $('#t_dashboard').value = data.notes.dashboard || '';
    }
  }

  function download(filename, obj) {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
    savedThisSession = true;
    $('#saveNotice').style.display = 'none';
    dirty = false;
  }

  $('#saveBtn').addEventListener('click', () => download('mosaic-progress.json', collect()));

  $('#loadFile').addEventListener('change', (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const data = JSON.parse(r.result);
        apply(data);
      } catch (err) {
        alert('invalid file');
      }
    };
    r.readAsText(f);
  });

  // Auto-save and form tracking
  ['#t_ps101', '#t_coaching', '#t_jobs', '#t_resume', '#t_dashboard'].forEach(sel =>
    $(sel)?.addEventListener('input', () => {
      markDirty();
      saveAuto();
    })
  );

  document.getElementsByName('fb_experience').forEach(el =>
    el.addEventListener('change', () => {
      markDirty();
      saveAuto();
    })
  );

  const AUTO = 'mosaic_auto_v2';
  function saveAuto() {
    localStorage.setItem(AUTO, JSON.stringify(collect()));
  }

  function loadAuto() {
    try {
      const data = JSON.parse(localStorage.getItem(AUTO) || '{}');
      if (Object.keys(data).length) apply(data);
    } catch (e) {
      console.error('Failed to load auto-save:', e);
    }
  }

  window.addEventListener('beforeunload', (e) => {
    if (dirty && !savedThisSession) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  $('#noticeSave').addEventListener('click', () => download('mosaic-progress.json', collect()));
  $('#noticeDismiss').addEventListener('click', () => {
    $('#saveNotice').style.display = 'none';
  });

  // Smooth anchors + soft routing
  function smoothTo(id) {
    const el = $(id);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.addEventListener('click', evt => {
      const href = a.getAttribute('href');
      if (href && href.length > 1) {
        evt.preventDefault();
        smoothTo(href);
      }
    });
  });

  function softRoute(txt) {
    const t = (txt || '').toLowerCase();
    if (t.includes('fast')) smoothTo('#ps101');
    if (t.includes('discover')) smoothTo('#modules');
    if (t.includes('dashboard')) smoothTo('#dashboard');
  }

  // Navigation links
  $('#showJourney').addEventListener('click', e => {
    e.preventDefault();
    smoothTo('#modules');
  });

  $('#linkFast').addEventListener('click', e => {
    e.preventDefault();
    smoothTo('#ps101');
  });

  $('#linkDiscover').addEventListener('click', e => {
    e.preventDefault();
    smoothTo('#modules');
  });

  // Ask coach module links
  document.querySelectorAll('[data-coach]').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const msg = a.getAttribute('data-coach');
      chat.style.display = 'block';
      chatInput.value = msg;
      send();
    });
  });

  // Initialize
  loadAuto();
  loadFeedbackAuto();
  startAutoSave();
})();
</script>