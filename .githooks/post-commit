#!/bin/bash
# Auto-sync to GDrive after every commit
# Tracked hook so agents keep automation active when core.hooksPath=.githooks

set -euo pipefail

PROJECT_DIR_DEFAULT="/Users/damianseguin/Downloads/WIMD-Railway-Deploy-Project"
GDRIVE_PATH_DEFAULT="gdrive:WIMD-Railway-Deploy-Project"
RCLONE_DEFAULT="/Users/damianseguin/coachvox_tools/bin/rclone"

# Allow overrides so other operators can customize paths without editing hook
PROJECT_DIR="${GDRIVE_PROJECT_DIR:-$PROJECT_DIR_DEFAULT}"
GDRIVE_PATH="${GDRIVE_SYNC_REMOTE:-$GDRIVE_PATH_DEFAULT}"
RCLONE_BIN="${GDRIVE_RCLONE_BIN:-$RCLONE_DEFAULT}"

log_info() {
  echo "[GDRIVE-SYNC] $1"
}

if [[ ! -x "$RCLONE_BIN" ]]; then
  log_info "Skipping sync (rclone not found at $RCLONE_BIN). Set GDRIVE_RCLONE_BIN to override."
  exit 0
fi

if [[ ! -d "$PROJECT_DIR" ]]; then
  log_info "Skipping sync (project dir $PROJECT_DIR missing). Set GDRIVE_PROJECT_DIR to override."
  exit 0
fi

if [[ -z "$GDRIVE_PATH" ]]; then
  log_info "Skipping sync (no remote configured). Set GDRIVE_SYNC_REMOTE to continue."
  exit 0
fi

# Run sync in background to avoid blocking git workflow
(
  "$RCLONE_BIN" sync "$PROJECT_DIR" "$GDRIVE_PATH" \
    --exclude ".git/**" \
    --exclude "node_modules/**" \
    --exclude "venv/**" \
    --exclude ".venv/**" \
    --exclude ".test-venv/**" \
    --exclude ".claude-run/**" \
    --exclude "__pycache__/**" \
    --exclude "*.pyc" \
    --exclude ".DS_Store" \
    --exclude "*.log" \
    --fast-list \
    --transfers 4 \
    > /tmp/gdrive-sync.log 2>&1

  if [[ $? -eq 0 ]]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ✅ GDrive sync complete" >> /tmp/gdrive-sync.log
  else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ❌ GDrive sync failed" >> /tmp/gdrive-sync.log
  fi
) &

log_info "Started background sync to Google Drive (monitor /tmp/gdrive-sync.log)"

# Auto-create handoff manifest for session continuity (3.A requirement)
TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
HANDOFF_FILE=".ai-agents/handoff_$TIMESTAMP.json"
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
BRANCH=$(git branch --show-current)
LATEST_BACKUP=$(ls -t backups/site-backup_*.zip 2>/dev/null | head -1 || echo "none")

# Check critical features
AUTH_PRESENT=$(grep -c "authModal" mosaic_ui/index.html 2>/dev/null || echo "0")
PS101_PRESENT=$(grep -c "PS101State" mosaic_ui/index.html 2>/dev/null || echo "0")

# Create handoff manifest
cat > "$HANDOFF_FILE" <<EOF
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "commit": "$COMMIT_HASH",
  "commit_message": "$(echo "$COMMIT_MSG" | sed 's/"/\\"/g')",
  "branch": "$BRANCH",
  "latest_backup": "$(basename "$LATEST_BACKUP")",
  "critical_features": {
    "auth_present": $([ "$AUTH_PRESENT" -gt 0 ] && echo "true" || echo "false"),
    "ps101_present": $([ "$PS101_PRESENT" -gt 0 ] && echo "true" || echo "false")
  },
  "session_continuity": {
    "last_5_commits": [
$(git log -5 --pretty=format:'      "%h: %s"' | sed '$ ! s/$/,/')
    ],
    "modified_files": [
$(git diff-tree --no-commit-id --name-only -r HEAD | sed 's/^/      "/' | sed 's/$/"/' | sed '$ ! s/$/,/')
    ]
  },
  "next_agent_checklist": [
    "Review this handoff manifest",
    "Verify backup exists: $LATEST_BACKUP",
    "Run: ./scripts/verify_critical_features.sh",
    "Check git log for recent changes",
    "Read .ai-agents/SESSION_START_PROTOCOL.md"
  ]
}
EOF

echo "[HANDOFF] Created: $HANDOFF_FILE"
echo "[HANDOFF] Commit: $COMMIT_HASH"
echo "[HANDOFF] Backup: $(basename "$LATEST_BACKUP")"
